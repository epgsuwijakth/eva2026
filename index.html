<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Executive Dashboard ‚Äî ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ v1.12</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700;800;900&family=IBM+Plex+Sans+Thai:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root {
  --bg-primary: #0f1117;
  --bg-card: #181b24;
  --bg-card-hover: #1e2230;
  --border: #2a2e3b;
  --text-primary: #f0f1f5;
  --text-secondary: #9ba1b0;
  --text-muted: #6b7185;
  --accent-blue: #4e8cff;
  --accent-green: #34d399;
  --accent-amber: #fbbf24;
  --accent-rose: #fb7185;
  --accent-purple: #a78bfa;
  --accent-cyan: #22d3ee;
  --shadow-card: 0 4px 24px rgba(0,0,0,0.3);
  --radius: 16px;
  --radius-sm: 10px;
  --pad-x: 48px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Noto Sans Thai', 'IBM Plex Sans Thai', sans-serif;
  background: var(--bg-primary); color: var(--text-primary);
  min-height: 100vh; font-size: 16px; line-height: 1.6;
  -webkit-tap-highlight-color: transparent;
}
::-webkit-scrollbar { width:6px; height:6px; }
::-webkit-scrollbar-track { background:var(--bg-primary); }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

/* ========== LOGIN SCREEN ========== */
#loginScreen {
  display:flex; justify-content:center; align-items:center; min-height:100vh;
  background: radial-gradient(ellipse at 30% 20%, rgba(78,140,255,0.08) 0%, transparent 50%),
              radial-gradient(ellipse at 70% 80%, rgba(99,102,241,0.06) 0%, transparent 50%),
              var(--bg-primary);
  padding: 20px;
}
.login-card {
  background: var(--bg-card); border:1px solid var(--border); border-radius:var(--radius);
  padding: 48px 44px; width: 100%; max-width: 420px;
  box-shadow: 0 24px 80px rgba(0,0,0,0.5);
  animation: modalIn 0.5s cubic-bezier(0.16,1,0.3,1) both;
}
.login-card .login-icon { text-align:center; font-size:3.5rem; margin-bottom:16px; }
.login-card h1 { text-align:center; font-size:1.5rem; font-weight:800; margin-bottom:6px; }
.login-card .login-sub { text-align:center; font-size:0.9rem; color:var(--text-muted); margin-bottom:32px; }
.login-field { margin-bottom:20px; }
.login-field label { display:block; font-size:0.82rem; font-weight:700; color:var(--text-secondary); margin-bottom:8px; text-transform:uppercase; letter-spacing:0.5px; }
.login-field input {
  width:100%; padding:14px 18px; border-radius:var(--radius-sm);
  background:var(--bg-primary); border:1px solid var(--border);
  color:var(--text-primary); font-family:inherit; font-size:1rem; font-weight:500;
  outline:none; transition:all 0.2s;
}
.login-field input:focus { border-color:var(--accent-blue); box-shadow:0 0 0 3px rgba(78,140,255,0.15); }
.login-error { color:var(--accent-rose); font-size:0.88rem; font-weight:600; text-align:center; margin-bottom:16px; min-height:1.4em; }
.btn-login {
  width:100%; padding:16px; border-radius:var(--radius-sm); border:none;
  background:linear-gradient(135deg,#4e8cff 0%,#6366f1 100%);
  color:#fff; font-family:inherit; font-size:1.1rem; font-weight:700;
  cursor:pointer; transition:all 0.25s;
  box-shadow:0 4px 20px rgba(78,140,255,0.3);
}
.btn-login:hover { transform:translateY(-1px); box-shadow:0 6px 28px rgba(78,140,255,0.45); }
.btn-login:disabled { opacity:0.7; cursor:wait; transform:none; }
.login-footer { text-align:center; margin-top:24px; font-size:0.78rem; color:var(--text-muted); }

/* ========== DASHBOARD SCREEN ========== */
#dashboardScreen { display:none; }

/* Header */
.header {
  background: linear-gradient(180deg, #181b24 0%, var(--bg-primary) 100%);
  border-bottom: 1px solid var(--border);
  padding: 24px var(--pad-x) 20px; position: sticky; top:0; z-index:100;
}
.header-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px; gap:16px; }
.header-title-wrap { flex:1; min-width:0; }
.header h1 {
  font-size:1.75rem; font-weight:800; letter-spacing:-0.5px;
  background:linear-gradient(135deg,#fff 0%,#9ba1b0 100%);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
.header .subtitle { font-size:0.92rem; color:var(--text-secondary); margin-top:4px; font-weight:400; }
.header .subtitle span.sheet-lbl { color:var(--accent-cyan); font-weight:600; }
.header-actions { display:flex; gap:10px; align-items:center; flex-wrap:wrap; flex-shrink:0; }
.badge {
  padding:6px 14px; border-radius:50px; font-size:0.8rem; font-weight:600;
  border:1px solid var(--border); background:var(--bg-card); white-space:nowrap;
}
.badge.live { border-color:var(--accent-green); color:var(--accent-green); }
.badge.live::before { content:''; display:inline-block; width:7px; height:7px; border-radius:50%; background:var(--accent-green); margin-right:6px; animation:pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

.btn-logout {
  font-family:inherit; font-size:0.82rem; font-weight:600;
  padding:8px 16px; border-radius:var(--radius-sm);
  background:transparent; border:1px solid rgba(251,113,133,0.3);
  color:var(--accent-rose); cursor:pointer; transition:all 0.25s;
  display:inline-flex; align-items:center; gap:6px; white-space:nowrap;
}
.btn-logout:hover { border-color:var(--accent-rose); background:rgba(251,113,133,0.08); }

/* Filter Bar & Accordion */
.filter-bar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.filter-bar input, .filter-bar select {
  font-family:inherit; font-size:0.95rem; font-weight:500;
  padding:10px 16px; border-radius:var(--radius-sm);
  background:var(--bg-card); border:1px solid var(--border);
  color:var(--text-primary); outline:none; transition:all 0.2s;
  min-width:0;
}
.filter-bar input { flex:1; min-width:180px; }
.filter-bar select { flex:0 1 200px; cursor:pointer; min-width:140px; }
.filter-bar input:focus, .filter-bar select:focus {
  border-color:var(--accent-blue); box-shadow:0 0 0 3px rgba(78,140,255,0.15);
}

/* Mobile Toggle Button */
.mobile-filter-toggle { display:none; width:100%; padding:12px; border-radius:var(--radius-sm); background:var(--bg-card); border:1px solid var(--border); color:var(--text-secondary); font-weight:600; font-size:0.9rem; align-items:center; justify-content:space-between; cursor:pointer; margin-bottom:8px; transition: background 0.2s; }
.mobile-filter-toggle:active { background: var(--bg-card-hover); }

/* Buttons */
.btn-reset,.btn-import,.btn-clear {
  font-family:inherit; font-size:0.85rem; font-weight:600;
  padding:10px 18px; border-radius:var(--radius-sm);
  cursor:pointer; transition:all 0.25s; border:1px solid var(--border);
  display:inline-flex; align-items:center; gap:6px; white-space:nowrap;
}
.btn-reset { background:transparent; color:var(--text-secondary); }
.btn-reset:hover { border-color:var(--accent-rose); color:var(--accent-rose); }
.btn-import {
  background:linear-gradient(135deg,#4e8cff 0%,#6366f1 100%);
  color:#fff; border:none; box-shadow:0 2px 12px rgba(78,140,255,0.3);
}
.btn-import:hover { transform:translateY(-1px); box-shadow:0 4px 20px rgba(78,140,255,0.45); }
.btn-clear { background:transparent; color:var(--accent-amber); border-color:rgba(251,191,36,0.3); }
.filter-spacer { flex:1; min-width:0; }
#fileInput { display:none; }

/* Toast */
.toast-container { position:fixed; top:24px; right:24px; z-index:9999; display:flex; flex-direction:column; gap:10px; }
.toast {
  padding:16px 44px 16px 20px; border-radius:var(--radius-sm);
  font-family:inherit; font-size:0.92rem; font-weight:600;
  display:flex; align-items:flex-start; gap:12px;
  min-width:320px; max-width:480px;
  box-shadow:0 8px 32px rgba(0,0,0,0.5);
  animation:toastIn 0.4s cubic-bezier(0.16,1,0.3,1) both;
  border:1px solid transparent; position:relative;
}
.toast.hiding { animation:toastOut 0.35s ease-in both; }
@keyframes toastIn { from{opacity:0;transform:translateX(60px) scale(0.95)} to{opacity:1;transform:translateX(0) scale(1)} }
@keyframes toastOut { to{opacity:0;transform:translateX(60px) scale(0.95)} }
.toast-icon { font-size:1.3rem; flex-shrink:0; line-height:1; margin-top:1px; }
.toast-body { flex:1; }
.toast-title { font-size:0.92rem; font-weight:700; margin-bottom:2px; }
.toast-msg { font-size:0.82rem; font-weight:400; opacity:0.85; line-height:1.5; }
.toast-close {
  position:absolute; top:10px; right:12px; background:none; border:none;
  color:inherit; opacity:0.5; cursor:pointer; font-size:1rem; line-height:1;
}
.toast.success { background:#0d2818; border-color:rgba(52,211,153,0.3); color:var(--accent-green); }
.toast.error   { background:#2a0f14; border-color:rgba(251,113,133,0.3); color:var(--accent-rose); }
.toast.warning { background:#2a1f0a; border-color:rgba(251,191,36,0.3); color:var(--accent-amber); }
.toast.info    { background:#0f1a2e; border-color:rgba(78,140,255,0.3); color:var(--accent-blue); }

/* Import Modal */
.import-overlay {
  display:none; position:fixed; inset:0; z-index:500;
  background:rgba(0,0,0,0.6); backdrop-filter:blur(4px);
  justify-content:center; align-items:center; padding:20px;
}
.import-overlay.active { display:flex; }
.import-box {
  background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius);
  padding:36px 40px; max-width:520px; width:100%;
  box-shadow:0 24px 80px rgba(0,0,0,0.6); text-align:center;
  animation:modalIn 0.35s cubic-bezier(0.16,1,0.3,1) both;
}
@keyframes modalIn { from{opacity:0;transform:scale(0.92) translateY(20px)} to{opacity:1;transform:scale(1) translateY(0)} }
.import-box h2 { font-size:1.35rem; font-weight:800; margin-bottom:8px; }
.drop-zone {
  border:2px dashed var(--border); border-radius:var(--radius-sm);
  padding:40px 24px; margin-bottom:20px; cursor:pointer; transition:all 0.25s;
  background:var(--bg-primary);
}
.drop-zone:hover,.drop-zone.dragover { border-color:var(--accent-blue); background:rgba(78,140,255,0.04); }
.spinner { display:none; margin:16px auto; }
.spinner.active { display:block; }
.spinner svg { animation:spin 1s linear infinite; width:36px; height:36px; }
@keyframes spin { to{transform:rotate(360deg)} }

/* Main */
.main { padding:24px var(--pad-x) 64px; }

/* Empty State */
.empty-state { text-align:center; padding:80px 20px; }
.empty-state .es-icon { font-size:3.5rem; margin-bottom:16px; opacity:0.6; }
.empty-state h2 { font-size:1.4rem; font-weight:700; color:var(--text-secondary); margin-bottom:8px; }
.empty-state p { color:var(--text-muted); font-size:0.95rem; max-width:400px; margin:0 auto 24px; line-height:1.7; }
.empty-state .btn-import { padding:14px 36px; font-size:1rem; }

/* Summary */
.summary-row { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:28px; }
.summary-card {
  background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius);
  padding:20px 22px; position:relative; overflow:hidden; transition:all 0.3s;
}
.summary-card:hover { border-color:var(--accent-blue); transform:translateY(-2px); box-shadow:var(--shadow-card); }
.summary-card .label { font-size:0.82rem; color:var(--text-secondary); font-weight:500; margin-bottom:6px; padding-right:50px; }
.summary-card .value { font-size:2rem; font-weight:800; }
.summary-card .sub { font-size:0.8rem; color:var(--text-muted); margin-top:4px; }
.summary-card .icon {
  position:absolute; top:18px; right:18px; width:42px; height:42px;
  border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:1.2rem;
}
.icon-blue { background:rgba(78,140,255,0.12); }
.icon-green { background:rgba(52,211,153,0.12); }
.icon-amber { background:rgba(251,191,36,0.12); }
.icon-rose  { background:rgba(251,113,133,0.12); }

/* Charts */
.charts-row { display:grid; grid-template-columns:2fr 1fr; gap:16px; margin-bottom:28px; }
.chart-card {
  background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius);
  padding:22px; transition:all 0.3s; overflow:hidden;
  display: flex; flex-direction: column;
}
.chart-card:hover { box-shadow:var(--shadow-card); }
.chart-card h3 { font-size:1.05rem; font-weight:700; margin-bottom:16px; }
.chart-container { position: relative; flex: 1; width: 100%; min-height: 280px; }

/* Scrollable Chart Wrapper for Mobile */
.chart-scroll-wrapper { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; position: relative; }
/* The inner box will have dynamic width on mobile */
.chart-scroll-content { position: relative; height: 300px; width: 100%; }

/* Legend */
.legend-bar {
  display:flex; gap:20px; align-items:center; margin-bottom:20px; flex-wrap:wrap;
  padding:12px 18px; background:var(--bg-card); border-radius:var(--radius-sm); border:1px solid var(--border);
}
.legend-item { display:flex; align-items:center; gap:6px; font-size:0.82rem; font-weight:600; color:var(--text-secondary); }
.legend-dot { width:10px; height:10px; border-radius:3px; }
.legend-dot.l67   { background:var(--accent-amber); }
.legend-dot.lself { background:var(--accent-cyan); }
.legend-dot.lmgr  { background:var(--accent-purple); }

/* Person Cards */
.position-group { margin-bottom:28px; }
.position-header {
  display:flex; align-items:center; gap:12px; margin-bottom:14px;
  padding-bottom:10px; border-bottom:2px solid var(--border);
}
.position-dot { width:12px; height:12px; border-radius:50%; }
.position-header h2 { font-size:1.2rem; font-weight:700; }
.position-count {
  font-size:0.8rem; color:var(--text-muted); font-weight:500;
  background:var(--bg-card); padding:3px 12px; border-radius:50px; border:1px solid var(--border);
}

.person-card {
  background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius);
  padding:22px 24px; margin-bottom:14px; transition:all 0.3s;
  animation:fadeInUp 0.4s ease-out both;
}
.person-card:hover { border-color:var(--accent-blue); box-shadow:var(--shadow-card); transform:translateY(-1px); }
@keyframes fadeInUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }

.person-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:18px; gap:16px; }
.person-info { min-width:0; flex:1; }
.person-info h3 { font-size:1.1rem; font-weight:700; margin-bottom:4px; word-break:break-word; }
.person-info .pos-tag { display:inline-block; font-size:0.78rem; font-weight:600; padding:3px 12px; border-radius:50px; }
.person-scores { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.score-pill {
  text-align:center; padding:8px 14px; border-radius:var(--radius-sm);
  background:var(--bg-primary); border:1px solid var(--border); min-width:90px;
}
.score-pill .sc-label { font-size:0.65rem; color:var(--text-muted); font-weight:600; text-transform:uppercase; letter-spacing:0.4px; margin-bottom:3px; }
.score-pill .sc-val { font-size:1.3rem; font-weight:800; }
.score-pill.highlight { border-color:var(--accent-blue); background:rgba(78,140,255,0.06); }

.comparison-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px 24px; }
.comp-item { display:flex; align-items:center; gap:10px; }
.comp-label { font-size:0.78rem; color:var(--text-secondary); min-width:140px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.comp-bars { flex:1; display:flex; flex-direction:column; gap:2px; }
.comp-bar-row { display:flex; align-items:center; gap:6px; }
.comp-bar-tag { font-size:0.6rem; font-weight:700; min-width:20px; color:var(--text-muted); }
.comp-bar-track { flex:1; height:7px; background:var(--bg-primary); border-radius:4px; overflow:hidden; }
.comp-bar-fill { height:100%; border-radius:4px; transition:width 0.8s ease-out; }
.comp-bar-val { font-size:0.7rem; font-weight:700; min-width:28px; text-align:right; }
.bar-67   { background:var(--accent-amber); }
.bar-self { background:var(--accent-cyan); }
.bar-mgr  { background:var(--accent-purple); }

.analysis-box {
  margin-top:16px; padding:14px 18px; border-radius:var(--radius-sm);
  background:linear-gradient(135deg,rgba(78,140,255,0.04) 0%,rgba(99,102,241,0.04) 100%);
  border:1px solid rgba(78,140,255,0.1);
}
.analysis-box .analysis-title { font-size:0.78rem; font-weight:700; color:var(--accent-blue); margin-bottom:5px; text-transform:uppercase; letter-spacing:0.5px; }
.analysis-box p { font-size:0.88rem; color:var(--text-secondary); line-height:1.7; }

.trend-up { color:var(--accent-green); }
.trend-down { color:var(--accent-rose); }
.trend-same { color:var(--accent-amber); }
.no-results { text-align:center; padding:60px 20px; color:var(--text-muted); font-size:1rem; }
.no-results .emoji { font-size:2.5rem; margin-bottom:12px; }

/* Responsive adjustments */
@media (max-width:1200px) {
  .summary-row { grid-template-columns:repeat(2,1fr); }
  .charts-row { grid-template-columns:1fr; }
}

@media (max-width:768px) {
  :root { --pad-x: 16px; }
  .header { padding: 16px var(--pad-x); }
  
  /* Fix Header Layout Mobile - Stack vertically properly */
  .header-top {
    flex-direction: column;
    gap: 16px;
    align-items: flex-start;
  }
  .header-title-wrap {
    width: 100%;
    min-width: 0;
  }
  .header h1 {
    white-space: normal; /* Allow wrap */
    word-break: break-word; /* Prevent giant words from breaking layout */
    line-height: 1.3;
    font-size: 1.5rem;
  }
  .header .subtitle {
    white-space: normal;
    line-height: 1.4;
    margin-bottom: 8px;
  }
  .header-actions {
    width: 100%;
    justify-content: flex-start;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  .mobile-filter-toggle { display: flex; }
  .filter-bar { 
    display: none; 
    flex-direction: column; 
    width: 100%; 
    gap: 10px; 
    margin-top: 5px;
    padding-bottom: 10px;
    animation: fadeInDown 0.3s ease;
  }
  .filter-bar.active { display: flex; }
  .filter-bar input, .filter-bar select { width: 100%; flex: none; }
  .filter-actions-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; }
  .filter-actions-row button { justify-content: center; width: 100%; }
  .filter-spacer { display:none; }
  
  .charts-row { gap: 12px; }
  /* Remove fixed min-height for chart container to let dynamic sizing work */
  
  .person-top { flex-direction:column; }
  .person-scores { width:100%; display:grid; grid-template-columns:repeat(2,1fr); gap:8px; }
  .score-pill { min-width:0; padding:8px 10px; }
  .comparison-grid { grid-template-columns: 1fr; gap: 8px; }
  .comp-label { min-width:100px; font-size:0.72rem; }
}
@keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<div class="toast-container" id="toastContainer"></div>

<!-- ==================== LOGIN SCREEN ==================== -->
<div id="loginScreen">
  <div class="login-card">
    <div class="login-icon">üîê</div>
    <h1>Executive Dashboard</h1>
    <div class="login-sub">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô v1.12</div>
    <div class="login-field"><label>Username</label><input type="text" id="loginUser" placeholder="Enter username" autocomplete="off" autocapitalize="off"></div>
    <div class="login-field"><label>Password</label><input type="password" id="loginPass" placeholder="Enter password"></div>
    <div class="login-error" id="loginError"></div>
    <button class="btn-login" onclick="attemptLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <div class="login-footer">üõ°Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° ‡∏û.‡∏£.‡∏ö.‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (PDPA)</div>
  </div>
</div>

<!-- ==================== DASHBOARD SCREEN ==================== -->
<div id="dashboardScreen">
  <!-- Import Modal -->
  <div class="import-overlay" id="importOverlay">
    <div class="import-box">
      <h2>üìÇ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h2>
      <p>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå <strong>.xlsx</strong> ‡∏ó‡∏µ‡πà‡∏°‡∏µ 3 Sheet</p>
      <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <div style="font-size:2.5rem;text-align:center;">üìÑ</div>
        <div style="text-align:center;font-weight:600;color:var(--text-secondary);">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡∏°‡∏≤‡∏ß‡∏≤‡∏á</div>
        <div id="dzFileName" style="display:none; color:var(--accent-green); margin-top:10px; text-align:center; font-weight:700;"></div>
      </div>
      <div class="spinner" id="importSpinner">
        <svg viewBox="0 0 50 50"><circle cx="25" cy="25" r="20" fill="none" stroke="var(--accent-blue)" stroke-width="4" stroke-dasharray="80 40" stroke-linecap="round"/></svg>
      </div>
      <div style="display:flex; gap:10px; justify-content:center;">
        <button class="btn-import" id="btnConfirmImport" onclick="confirmImport()" disabled>üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <button class="btn-cancel" onclick="closeImportModal()" style="background:transparent; border:1px solid var(--border); color:var(--text-secondary); cursor:pointer; padding:10px 20px; border-radius:var(--radius-sm);">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>

  <div class="header">
    <div class="header-top">
      <div class="header-title-wrap">
        <h1>üìä Executive Performance Dashboard</h1>
        <div class="subtitle">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö 3 ‡∏£‡∏≠‡∏ö (<span class="sheet-lbl" id="sheetNames">...</span>)</div>
      </div>
      <div class="header-actions">
        <span class="badge live">Dashboard</span>
        <span class="badge" id="badgeCount">...</span>
        <button class="btn-logout" onclick="doLogout()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>
    
    <!-- Mobile Collapse Trigger -->
    <div class="mobile-filter-toggle" onclick="toggleFilters()">
      <span>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</span> <span id="toggleIcon">‚ñº</span>
    </div>

    <!-- Filter Bar (Accordion Content) -->
    <div class="filter-bar" id="filterBar">
      <input type="text" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." oninput="applyFilters()">
      <select id="positionFilter" onchange="applyFilters()">
        <option value="">‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>
      </select>
      <div class="filter-spacer"></div>
      <div class="filter-actions-row">
        <button class="btn-reset" onclick="resetFilters()">‚úï ‡∏•‡πâ‡∏≤‡∏á</button>
        <button class="btn-import" onclick="openImportModal()">üì• Import</button>
        <button class="btn-clear" onclick="clearDataConfirm()">üóëÔ∏è Clear</button>
      </div>
      <input type="file" id="fileInput" accept=".xlsx" onchange="handleFileSelect(event)">
    </div>
  </div>

  <div class="main" id="mainContent">
    <div class="summary-row" id="summaryRow"></div>
    <div class="charts-row" id="chartsRow">
      <div class="chart-card">
        <h3>üìà ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö Totals 3 ‡∏£‡∏≠‡∏ö ‚Äî ‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h3>
        <!-- Scroll Wrapper for Bar Chart -->
        <div class="chart-scroll-wrapper">
          <div class="chart-scroll-content" id="barChartBox">
            <canvas id="barChart"></canvas>
          </div>
        </div>
      </div>
      <div class="chart-card">
        <h3>üè∑Ô∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</h3>
        <div class="chart-container"><canvas id="doughnutChart"></canvas></div>
      </div>
    </div>
    <div class="legend-bar" id="legendBar">
      <span style="font-weight:700;color:var(--text-primary);margin-right:6px;">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå:</span>
      <div class="legend-item"><div class="legend-dot l67"></div> <span id="lbl1"></span></div>
      <div class="legend-item"><div class="legend-dot lself"></div> <span id="lbl2"></span></div>
      <div class="legend-item"><div class="legend-dot lmgr"></div> <span id="lbl3"></span></div>
    </div>
    <div id="personContainer"></div>
  </div>
</div>

<script>
// Authentication & Encryption Logic
const _h1 = 'ba8a96d5e6bd977e469fff203a17ac8b53682776119dd11081a6cede330cba6b';
const _h2 = '39eecc93dd906bc79fcf108be4c35122af40c6e7fdc17edefdec71b188d4e063';

// Static Data from Data.xlsx (Updated 2026-02-11 v1.12 - Corrected Values)
// This serves as the default data set if login is successful
const _staticData = [
  {no:1,name:'‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏†‡∏≤‡∏ì‡∏∏‡∏£‡∏±‡∏ï‡∏ô‡πå ‡∏™‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏á (‡πÅ‡∏ô‡∏ô)',position:'Sr. Product Development',eval67:{scores:[4,3.5,3.5,3.5,3.5,4,3.5,4,3.5,3.5],scoreWork:3.60,scorePerson:3.67,total:3.62},self68:{scores:[4,3,3,3,2,4,4,4,3,3],scoreWork:3.00,scorePerson:3.50,total:3.15},mgr68:{scores:[4,4,3.5,3.5,3.5,4,4,4,3,3.5],scoreWork:3.70,scorePerson:3.62,total:3.68}},
  {no:2,name:'‡∏ô‡∏≤‡∏¢‡∏û‡∏™‡∏¥‡∏©‡∏ê‡πå ‡∏ô‡∏¥‡∏¢‡∏°‡∏ó‡∏≠‡∏á (‡∏û‡∏•‡∏∏)',position:'Product Manager',eval67:{scores:[null,null,null,null,null,null,null,null,null,null],scoreWork:0.00,scorePerson:0.00,total:0.00},self68:{scores:[3,4,3,4,5,4,5,5,4,4],scoreWork:3.80,scorePerson:4.25,total:3.94},mgr68:{scores:[3,3.5,3,3.5,4,3.5,3.5,3.5,3.5,4],scoreWork:3.40,scorePerson:3.62,total:3.47}},
  {no:3,name:'‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏Å‡∏±‡∏ç‡∏ç‡∏≤‡∏û‡∏±‡∏ä‡∏£ ‡∏ò‡∏¥‡∏™‡∏≤‡∏£ (‡∏≠‡∏±‡∏¢‡∏¢‡πå)',position:'Business Analyst',eval67:{scores:[4,4,5,4,4,4,4,4,4,4],scoreWork:4.20,scorePerson:4.00,total:4.14},self68:{scores:[4,5,5,5,4,5,5,5,5,4],scoreWork:4.60,scorePerson:4.75,total:4.64},mgr68:{scores:[4,4,5,4.5,4,4.5,4.5,4.5,4.5,4],scoreWork:4.30,scorePerson:4.38,total:4.32}},
  {no:4,name:'‡∏ó‡∏®‡∏û‡∏• ‡∏Ñ‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç (‡πÄ‡∏ö‡∏Ñ)',position:'Business Analyst',eval67:{scores:[null,null,null,null,null,null,null,null,null,null],scoreWork:0.00,scorePerson:0.00,total:0.00},self68:{scores:[4,4,4,4,4,4,4,4,4,5],scoreWork:4.00,scorePerson:4.25,total:4.07},mgr68:{scores:[3.25,3.5,3.5,3.5,4,3.5,3.5,3.5,3.5,3.5],scoreWork:3.55,scorePerson:3.50,total:3.54}},
  {no:5,name:'‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ì‡∏±‡∏ê‡∏ô‡∏±‡∏ô‡∏ó‡πå ‡∏Å‡∏°‡∏•‡∏´‡∏±‡∏ï‡∏ñ‡πå (‡∏ô‡πâ‡∏≠‡∏¢)',position:'Senior Project Coordinator',eval67:{scores:[null,null,null,null,null,null,null,null,null,null],scoreWork:0.00,scorePerson:0.00,total:0.00},self68:{scores:[3,4,5,5,5,5,5,5,5,3],scoreWork:4.40,scorePerson:4.50,total:4.43},mgr68:{scores:[3.5,4,4,4,4,4,4,4,4,4],scoreWork:3.90,scorePerson:4.00,total:3.93}},
  {no:6,name:'‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ì‡∏†‡∏±‡∏ó‡∏£‡∏ä‡∏≤‡∏ô‡∏±‡∏ô‡∏ó‡πå ‡∏™‡∏∏‡∏ô‡∏ó‡∏£‡∏ò‡∏ô‡∏ß‡∏±‡∏à‡∏ô‡πå (‡πÄ‡∏Å‡πã)',position:'QA',eval67:{scores:[4,4,4,3.8,4,4,4,4,4,3.5],scoreWork:3.96,scorePerson:3.88,total:3.93},self68:{scores:[3,3,3,3,3,3,3,3,4,3],scoreWork:3.00,scorePerson:3.25,total:3.08},mgr68:{scores:[4,4,4,4,4,4,4,4,4,4],scoreWork:4.00,scorePerson:4.00,total:4.00}},
  {no:7,name:'‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡πÅ‡∏û‡∏£‡∏û‡∏¥‡πÑ‡∏• ‡∏û‡∏¥‡∏®‡∏≤‡∏•‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå(‡∏≠‡∏¥‡πã‡∏°)',position:'QA',eval67:{scores:[3,3.5,4,3.5,3,4,4,5,4,3],scoreWork:3.40,scorePerson:3.85,total:3.54},self68:{scores:[3,3,3,3,4,4,4,5,5,4],scoreWork:3.20,scorePerson:4.35,total:3.54},mgr68:{scores:[3,3.5,3.5,3.5,3,4,4,5,3.5,3.5],scoreWork:3.30,scorePerson:3.85,total:3.47}},
  {no:8,name:'‡∏ô‡∏≤‡∏¢‡∏õ‡∏¥‡∏¢‡∏∞‡∏û‡∏• ‡∏ó‡∏¥‡∏ô‡∏Å‡∏£ (‡πÇ‡∏ü‡∏Å‡∏±‡∏™)',position:'QA',eval67:{scores:[3.5,4,4,3,3,3.5,4,4,3,3],scoreWork:3.50,scorePerson:3.38,total:3.46},self68:{scores:[3,5,5,4,3,5,4,5,3,3],scoreWork:4.00,scorePerson:3.85,total:3.96},mgr68:{scores:[3.5,4,4,3.5,3,4,4,4,3,3.5],scoreWork:3.60,scorePerson:3.62,total:3.61}},
  {no:9,name:'‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏£‡∏±‡∏ï‡∏ô‡πå ‡∏™‡∏∏‡∏Ç‡πÉ‡∏™ (‡πÄ‡∏≠‡∏°)',position:'QA',eval67:{scores:[3,4,4,4,3,4,3,3,3,3],scoreWork:3.60,scorePerson:3.25,total:3.50},self68:{scores:[3,4,3,4,3,4,3,4,3,3],scoreWork:3.40,scorePerson:3.35,total:3.38},mgr68:{scores:[3.5,4,4,3.5,3,4,3.5,3.5,3,3.5],scoreWork:3.60,scorePerson:3.50,total:3.57}},
  {no:10,name:'‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏Å‡∏°‡∏•‡∏ß‡∏£‡∏£‡∏ì ‡∏û‡∏•‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì (‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà)',position:'Application Management',eval67:{scores:[3,4,4,3.5,3,3.5,4,4,3,3],scoreWork:3.50,scorePerson:3.38,total:3.46},self68:{scores:[3,5,5,3,3,5,4,5,3,3],scoreWork:3.80,scorePerson:3.85,total:3.81},mgr68:{scores:[3.5,4,4,3.5,3,3.5,4,4,3,3.5],scoreWork:3.60,scorePerson:3.50,total:3.57}},
  {no:11,name:'‡∏ô‡∏≤‡∏¢‡∏®‡∏∏‡∏†‡∏Å‡∏£ ‡πÄ‡∏Å‡∏©‡∏ä‡∏∏‡∏°‡∏û‡∏• (‡πÑ‡∏≠‡∏ã‡πå)',position:'Application Management',eval67:{scores:[3,4,4,3,3,4,3.5,4,3,3],scoreWork:3.40,scorePerson:3.42,total:3.41},self68:{scores:[3,5,5,4,3,4,3,3,4,3],scoreWork:4.00,scorePerson:3.50,total:3.85},mgr68:{scores:[3,4,4,3.5,3,4,3.5,3.5,3.5,3.5],scoreWork:3.50,scorePerson:3.62,total:3.54}}
];

let defaultData = [];
let rawData = [];
let sheetLabels = ['‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô 67','‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ï‡∏ô‡πÄ‡∏≠‡∏á 68','‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô 68'];
let dashboardInitialized = false;
let pendingFile = null;
const criteria = ['‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô','‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÉ‡∏ô‡∏á‡∏≤‡∏ô','‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤','‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡∏£‡∏¥‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤','‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô','‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠-‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô','‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠-‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô','‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô','‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û'];
const colorPalette = ['#4e8cff','#a78bfa','#34d399','#fbbf24','#fb7185','#22d3ee','#f97316','#84cc16','#ec4899','#14b8a6'];
let posColors = {};
let barC=null, doughC=null;

async function sha256(text) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

async function attemptLogin() {
  const u = document.getElementById('loginUser').value.trim().toLowerCase(); // Normalize username to lowercase
  const p = document.getElementById('loginPass').value;
  const errEl = document.getElementById('loginError');
  const btn = document.querySelector('.btn-login');

  if (!u || !p) { errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Username ‡πÅ‡∏•‡∏∞ Password'; return; }
  
  btn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...'; btn.disabled = true;
  
  try {
    const uh = await sha256(u);
    const ph = await sha256(p);
    if (uh === _h1 && ph === _h2) {
      errEl.textContent = '';
      // Use the static parsed data as default data (bypassing decryption for fallback)
      defaultData = _staticData;
      
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dashboardScreen').style.display = 'block';
      initDashboard();
    } else {
      errEl.textContent = '‚ùå Username ‡∏´‡∏£‡∏∑‡∏≠ Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
      document.getElementById('loginPass').value = '';
    }
  } catch(e) {
    errEl.textContent = '‚ùå ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
    console.error(e);
  } finally {
    btn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'; btn.disabled = false;
  }
}

// Enter key to login
document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') attemptLogin();
});

function toggleFilters() {
  const bar = document.getElementById('filterBar');
  const icon = document.getElementById('toggleIcon');
  const isActive = bar.classList.toggle('active');
  icon.textContent = isActive ? '‚ñ≤' : '‚ñº';
}

function initDashboard() {
  if(dashboardInitialized) return;
  dashboardInitialized = true;
  initDropZone();
  
  // Register DataLabels Plugin for Chart.js
  if (typeof ChartDataLabels !== 'undefined') {
    Chart.register(ChartDataLabels);
  }
  
  // Add resize listener to handle orientation change
  window.addEventListener('resize', () => {
    if(barC) {
      setTimeout(() => renderCharts(rawData), 200);
    }
  });

  rawData = [...defaultData];
  assignColors();
  updateUI();
  rebuildFilter();
  applyFilters();
}

function assignColors() {
  const pos = [...new Set(rawData.map(d=>d.position))];
  posColors = {}; pos.forEach((p,i)=>posColors[p]=colorPalette[i%colorPalette.length]);
}

function updateUI() {
  document.getElementById('sheetNames').textContent = sheetLabels.join(' / ');
  document.getElementById('lbl1').textContent = sheetLabels[0];
  document.getElementById('lbl2').textContent = sheetLabels[1];
  document.getElementById('lbl3').textContent = sheetLabels[2];
  document.getElementById('badgeCount').textContent = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${rawData.length} ‡∏Ñ‡∏ô`;
}

function rebuildFilter(){
  const sel=document.getElementById('positionFilter');
  sel.innerHTML='<option value="">‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>';
  [...new Set(rawData.map(d=>d.position))].forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p;sel.appendChild(o);});
}

function applyFilters() {
  const s = document.getElementById('searchInput').value.trim().toLowerCase();
  const p = document.getElementById('positionFilter').value;
  let filtered = rawData;
  if (s) filtered = filtered.filter(d => d.name.toLowerCase().includes(s));
  if (p) filtered = filtered.filter(d => d.position === p);
  
  renderSummary(filtered);
  renderCharts(filtered);
  renderCards(filtered);
}

function renderSummary(data) {
  const c = document.getElementById('summaryRow');
  if(!data.length) { c.innerHTML = ''; return; }
  
  const wM=data.filter(d=>d.mgr68.total>0),wS=data.filter(d=>d.self68.total>0);
  const aM=wM.length?wM.reduce((s,d)=>s+d.mgr68.total,0)/wM.length:0;
  const aS=wS.length?wS.reduce((s,d)=>s+d.self68.total,0)/wS.length:0;
  const top=[...data].filter(d=>d.mgr68.total>0).sort((a,b)=>b.mgr68.total-a.mgr68.total)[0];
  const pc=[...new Set(data.map(d=>d.position))].length;

  c.innerHTML = `
    <div class="summary-card"><div class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</div><div class="value">${data.length}</div><div class="sub">${pc} ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div><div class="icon icon-blue">üë•</div></div>
    <div class="summary-card"><div class="label">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (${sheetLabels[2]})</div><div class="value" style="color:var(--accent-green)">${aM.toFixed(2)}</div><div class="sub">${getGrade(aM).grade}</div><div class="icon icon-green">üìä</div></div>
    <div class="summary-card"><div class="label">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (${sheetLabels[1]})</div><div class="value" style="color:var(--accent-cyan)">${aS.toFixed(2)}</div><div class="sub">Gap: ${(aS-aM).toFixed(2)}</div><div class="icon icon-amber">üìù</div></div>
    <div class="summary-card"><div class="label">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (${sheetLabels[2]})</div><div class="value" style="color:var(--accent-purple)">${top?fmt(top.mgr68.total):'‚Äî'}</div><div class="sub">${top?top.name.match(/\(([^)]+)\)/)?.[1]||top.name:'‚Äî'}</div><div class="icon icon-rose">üèÜ</div></div>
  `;
}

function renderCharts(data) {
  const row = document.getElementById('chartsRow');
  const leg = document.getElementById('legendBar');
  if(!data.length) { row.style.display='none'; leg.style.display='none'; return; }
  row.style.display='grid'; leg.style.display='flex';

  const ctx1 = document.getElementById('barChart').getContext('2d');
  if(barC) barC.destroy();
  
  const sorted = [...data].sort((a,b) => b.mgr68.total - a.mgr68.total);
  const labels = sorted.map(d => { const m = d.name.match(/\(([^)]+)\)/); return m ? m[1] : d.name.substring(0,10); });

  // Mobile Sizing Logic: Explicit Width Calculation
  const barChartBox = document.getElementById('barChartBox');
  const scrollWrapper = document.querySelector('.chart-scroll-wrapper');
  
  if(window.innerWidth <= 768) {
    // Determine explicit width: 80px per person minimum for readability
    const minItemWidth = 80;
    const calculatedWidth = sorted.length * minItemWidth;
    // Ensure container has width before using it
    const containerWidth = scrollWrapper.clientWidth || (window.innerWidth - 64);
    
    // Set specific pixel width to force scroll if content is wider than container
    // If calculated width is smaller than container, use container width (full width)
    barChartBox.style.width = `${Math.max(calculatedWidth, containerWidth)}px`;
    barChartBox.style.height = '320px'; 
  } else {
    // Reset for desktop
    barChartBox.style.width = '100%';
    barChartBox.style.height = '100%';
    barChartBox.style.minHeight = '300px';
  }

  barC = new Chart(ctx1, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: sheetLabels[0], data: sorted.map(d=>d.eval67.total||null), backgroundColor: '#fbbf24', borderColor:'#fbbf24', borderWidth:1, borderRadius:4 },
        { label: sheetLabels[1], data: sorted.map(d=>d.self68.total||null), backgroundColor: '#22d3ee', borderColor:'#22d3ee', borderWidth:1, borderRadius:4 },
        { label: sheetLabels[2], data: sorted.map(d=>d.mgr68.total||null), backgroundColor: '#a78bfa', borderColor:'#a78bfa', borderWidth:1, borderRadius:4 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout:{padding:{top:30}},
      plugins: { 
        legend: { display: false },
        datalabels: {
          anchor: 'end',
          align: 'end',
          offset: -4,
          rotation: -90,
          color: ctx => ['#fbbf24','#22d3ee','#a78bfa'][ctx.datasetIndex] || '#9ba1b0',
          font: { family: 'Noto Sans Thai', size: 11, weight: '700' },
          formatter: v => (v === null || v === 0) ? '' : v.toFixed(2),
          padding: { bottom: 2 }
        }
      },
      scales: { 
        x:{ticks:{color:'#9ba1b0',font:{family:'Noto Sans Thai',size:11,weight:'600'},maxRotation:45},grid:{color:'rgba(42,46,59,0.5)'}},
        y: { min: 0, max: 5.5, ticks:{color:'#9ba1b0',stepSize:1},grid:{color:'rgba(42,46,59,0.5)'} } 
      }
    }
  });

  const ctx2 = document.getElementById('doughnutChart').getContext('2d');
  if(doughC) doughC.destroy();
  const pcnt = {}; data.forEach(d => pcnt[d.position] = (pcnt[d.position]||0)+1);

  doughC = new Chart(ctx2, {
    type: 'doughnut',
    data: {
      labels: Object.keys(pcnt),
      datasets: [{ data: Object.values(pcnt), backgroundColor: Object.keys(pcnt).map(p=>posColors[p]||'#6b7185'), borderColor:'#181b24', borderWidth:3 }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout:'60%',
      plugins: { datalabels:{display:false}, legend: { position: 'bottom', labels: { color: '#9ba1b0', font:{family:'Noto Sans Thai',size:11,weight:'600'}, padding:12 } } }
    }
  });
}

function renderCards(data) {
  const c = document.getElementById('personContainer');
  if(!data.length && !rawData.length) { renderEmpty(); return; }
  if(!data.length) { c.innerHTML='<div class="no-results"><div class="emoji">üîç</div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>'; return; }
  
  const groups={}; data.forEach(d=>{if(!groups[d.position])groups[d.position]=[];groups[d.position].push(d);});
  Object.values(groups).forEach(g=>g.sort((a,b)=>b.mgr68.total-a.mgr68.total));
  const sPos=Object.keys(groups).sort((a,b)=>groups[b].length-groups[a].length); // Sort by count simply

  let h='';
  sPos.forEach((pos,pi)=>{
    const ppl=groups[pos], col=posColors[pos]||'#6b7185';
    h+=`<div class="position-group"><div class="position-header"><div class="position-dot" style="background:${col}"></div><h2>${pos}</h2><span class="position-count">${ppl.length} ‡∏Ñ‡∏ô</span></div>`;
    ppl.forEach((p,idx)=>{
      const tr=getTrend(p.eval67.total,p.mgr68.total);
      h+=`<div class="person-card" style="animation-delay:${(pi*3+idx)*0.06}s">
        <div class="person-top"><div class="person-info"><h3>${p.name}</h3><span class="pos-tag" style="background:${col}15;color:${col};border:1px solid ${col}33">${p.position}</span></div>
        <div class="person-scores">
          <div class="score-pill"><div class="sc-label">${sheetLabels[0]}</div><div class="sc-val" style="color:var(--accent-amber)">${fmt(p.eval67.total)}</div></div>
          <div class="score-pill"><div class="sc-label">${sheetLabels[1]}</div><div class="sc-val" style="color:var(--accent-cyan)">${fmt(p.self68.total)}</div></div>
          <div class="score-pill highlight"><div class="sc-label">${sheetLabels[2]}</div><div class="sc-val" style="color:var(--accent-purple)">${fmt(p.mgr68.total)}</div></div>
          <div class="score-pill"><div class="sc-label">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°</div><div class="sc-val ${tr.cls}" style="font-size:1rem">${tr.icon} ${tr.text}</div></div>
        </div></div>
        <div class="comparison-grid">${criteria.map((cr,i)=>{
          const v1=p.eval67.scores[i],v2=p.self68.scores[i],v3=p.mgr68.scores[i];
          return `<div class="comp-item"><div class="comp-label">${cr}</div><div class="comp-bars">
            <div class="comp-bar-row"><span class="comp-bar-tag">67</span><div class="comp-bar-track"><div class="comp-bar-fill bar-67" style="width:${v1?v1/5*100:0}%"></div></div><span class="comp-bar-val" style="color:var(--accent-amber)">${v1!=null?fmtS(v1):'‚Äî'}</span></div>
            <div class="comp-bar-row"><span class="comp-bar-tag">‡∏ï‡∏ô</span><div class="comp-bar-track"><div class="comp-bar-fill bar-self" style="width:${v2?v2/5*100:0}%"></div></div><span class="comp-bar-val" style="color:var(--accent-cyan)">${v2!=null?fmtS(v2):'‚Äî'}</span></div>
            <div class="comp-bar-row"><span class="comp-bar-tag">‡∏´‡∏ô.</span><div class="comp-bar-track"><div class="comp-bar-fill bar-mgr" style="width:${v3?v3/5*100:0}%"></div></div><span class="comp-bar-val" style="color:var(--accent-purple)">${v3!=null?fmtS(v3):'‚Äî'}</span></div>
          </div></div>`;}).join('')}</div>
        <div class="analysis-box"><div class="analysis-title">üîé ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏£‡∏∏‡∏õ</div><p>${analyze(p)}</p></div>
      </div>`;
    });
    h+='</div>';
  });
  c.innerHTML=h;
}

// ========== UTILS & LOGIC (Restored) ==========
function fmt(v){return v!=null&&v!==0?v.toFixed(2):'‚Äî';}
function fmtS(v){return v!=null&&v!==0?v.toFixed(1):'‚Äî';}
function getTrend(o,c){
  if(!o||o===0)return{icon:'üÜï',cls:'trend-same',text:'‡πÉ‡∏´‡∏°‡πà'};
  const d=c-o;
  if(d>0.05)return{icon:'‚ñ≤',cls:'trend-up',text:`+${d.toFixed(2)}`};
  if(d<-0.05)return{icon:'‚ñº',cls:'trend-down',text:`${d.toFixed(2)}`};
  return{icon:'‚Äî',cls:'trend-same',text:'‡∏Ñ‡∏á‡∏ó‡∏µ‡πà'};
}
function getGrade(t){
  if(t>=4.5)return{grade:'‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°',color:'#34d399'};
  if(t>=4.0)return{grade:'‡∏î‡∏µ‡∏°‡∏≤‡∏Å',color:'#4e8cff'};
  if(t>=3.5)return{grade:'‡∏î‡∏µ',color:'#a78bfa'};
  if(t>=3.0)return{grade:'‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á',color:'#fbbf24'};
  if(t>0)return{grade:'‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á',color:'#fb7185'};
  return{grade:'‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',color:'#6b7185'};
}
function analyze(p){
  const sTotal=p.self68.total,mTotal=p.mgr68.total,eTotal=p.eval67.total;
  const mSc=p.mgr68.scores,sSc=p.self68.scores,eSc=p.eval67.scores;
  let r=[];
  const g=getGrade(mTotal);
  r.push(`‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÇ‡∏î‡∏¢${sheetLabels[2]}: <strong style="color:${g.color}">${fmt(mTotal)} (${g.grade})</strong>`);
  if(sTotal>0&&mTotal>0){const gap=sTotal-mTotal;if(gap>0.3)r.push(`‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤ ${gap.toFixed(2)} ‚Äî ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á`);else if(gap<-0.3)r.push(`‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡∏ô‡πÄ‡∏≠‡∏á ${Math.abs(gap).toFixed(2)}`);else r.push(`‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô (‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô ${Math.abs(gap).toFixed(2)})`);}
  
  const pc=[];
  for(let i=0;i<10;i++){const vals=[];if(mSc[i]!=null)vals.push(mSc[i]);if(sSc[i]!=null)vals.push(sSc[i]);if(eSc[i]!=null)vals.push(eSc[i]);if(!vals.length)continue;
    pc.push({i,name:criteria[i]||('‡∏´‡∏°‡∏ß‡∏î '+(i+1)),avg:vals.reduce((s,x)=>s+x,0)/vals.length});}
  if(pc.length>0){
    const sorted=[...pc].sort((a,b)=>b.avg-a.avg);
    const tops=sorted.slice(0,2).map(c=>`${c.name}`);
    const bots=sorted.slice(-2).reverse().map(c=>`${c.name}`);
    if(tops.length) r.push(`üí™ ‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á: ${tops.join(', ')}`);
    if(bots.length) r.push(`üîß ‡∏Ñ‡∏ß‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤: ${bots.join(', ')}`);
  }
  return r.join('<br>');
}

function renderEmpty(){
  document.getElementById('summaryRow').innerHTML='';
  document.getElementById('chartsRow').style.display='none';
  document.getElementById('legendBar').style.display='none';
  document.getElementById('personContainer').innerHTML=`
    <div class="empty-state"><div class="es-icon">üìÇ</div><h2>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx)</p>
    <button class="btn-import" onclick="openImportModal()">üì• Import Data</button></div>`;
}

// ========== TOAST & IMPORT ==========
function showToast(type,title,msg,dur=5000){
  const c=document.getElementById('toastContainer');
  const icons={success:'‚úÖ',error:'‚ùå',warning:'‚ö†Ô∏è',info:'‚ÑπÔ∏è'};
  const t=document.createElement('div'); t.className=`toast ${type}`;
  t.innerHTML=`<div class="toast-icon">${icons[type]||'‚ÑπÔ∏è'}</div><div class="toast-body"><div class="toast-title">${title}</div><div class="toast-msg">${msg}</div></div><button class="toast-close" onclick="this.parentElement.classList.add('hiding');setTimeout(()=>this.parentElement.remove(),350)">‚úï</button>`;
  c.appendChild(t); setTimeout(()=>{t.classList.add('hiding');setTimeout(()=>t.remove(),350);},dur);
}

function openImportModal(){ document.getElementById('importOverlay').classList.add('active'); }
function closeImportModal(){ document.getElementById('importOverlay').classList.remove('active'); }
function initDropZone(){
  const dz=document.getElementById('dropZone');
  dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('dragover');});
  dz.addEventListener('dragleave',()=>dz.classList.remove('dragover'));
  dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('dragover');if(e.dataTransfer.files.length>0)processSelectedFile(e.dataTransfer.files[0]);});
}
function handleFileSelect(e){if(e.target.files.length>0)processSelectedFile(e.target.files[0]);}

function processSelectedFile(file){
  if(!file.name.toLowerCase().endsWith('.xlsx')){showToast('error','‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î','‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå .xlsx ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');return;}
  pendingFile=file;
  const el=document.getElementById('dzFileName'); el.textContent=file.name; el.style.display='block';
  document.getElementById('btnConfirmImport').disabled=false;
}

function confirmImport(){
  if(!pendingFile)return;
  const spinner=document.getElementById('importSpinner'), btn=document.getElementById('btnConfirmImport');
  spinner.classList.add('active'); btn.disabled=true; btn.textContent='‚è≥ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
  
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
      if(wb.SheetNames.length<3) throw new Error('‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 Sheets');
      
      const s1=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:null});
      const s2=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[1]],{defval:null});
      const s3=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[2]],{defval:null});
      sheetLabels=[wb.SheetNames[0],wb.SheetNames[1],wb.SheetNames[2]];
      
      const allNames=[...new Set([...s1.map(r=>r['Name']),...s2.map(r=>r['Name']),...s3.map(r=>r['Name'])])].filter(Boolean);
      rawData=allNames.map((nm,i)=>{
        const r1=s1.find(r=>r['Name']===nm)||{};const r2=s2.find(r=>r['Name']===nm)||{};const r3=s3.find(r=>r['Name']===nm)||{};
        return{no:i+1,name:nm,position:r3['Position']||r2['Position']||r1['Position']||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',eval67:parseRow(r1),self68:parseRow(r2),mgr68:parseRow(r3)};
      });
      assignColors(); updateUI(); rebuildFilter(); applyFilters(); closeImportModal();
      showToast('success','‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${rawData.length} ‡∏Ñ‡∏ô`);
    }catch(err){showToast('error','‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',err.message);}
    finally{spinner.classList.remove('active');btn.disabled=false;btn.textContent='üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';}
  };
  reader.readAsArrayBuffer(pendingFile);
}

function parseRow(row){
  if(!row||!row['Name'])return{scores:Array(10).fill(null),total:0};
  const skip=new Set(['No','Name','Position','Score ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô','Score ‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•','Totals','‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô']);
  const keys=Object.keys(row).filter(k=>!skip.has(k.trim()));
  const scores=keys.slice(0,10).map(k=>{const v=row[k];return v!=null&&v!==''?parseFloat(v)||null:null;});
  while(scores.length<10)scores.push(null);
  return{scores,total:parseFloat(row['Totals'])||0};
}

function clearDataConfirm(){
  if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){rawData=[];renderEmpty();}
}
function doLogout() {
  location.reload();
}
function resetFilters() {
  document.getElementById('searchInput').value='';
  document.getElementById('positionFilter').value='';
  applyFilters();
}
</script>
</body>
</html>