<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Executive Dashboard ‚Äî ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700;800;900&family=IBM+Plex+Sans+Thai:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root {
  --bg-primary: #0f1117;
  --bg-card: #181b24;
  --bg-card-hover: #1e2230;
  --border: #2a2e3b;
  --text-primary: #f0f1f5;
  --text-secondary: #9ba1b0;
  --text-muted: #6b7185;
  --accent-blue: #4e8cff;
  --accent-green: #34d399;
  --accent-amber: #fbbf24;
  --accent-rose: #fb7185;
  --accent-purple: #a78bfa;
  --accent-cyan: #22d3ee;
  --shadow-card: 0 4px 24px rgba(0,0,0,0.3);
  --radius: 16px;
  --radius-sm: 10px;
  --pad-x: 48px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Noto Sans Thai', 'IBM Plex Sans Thai', sans-serif;
  background: var(--bg-primary); color: var(--text-primary);
  min-height: 100vh; font-size: 16px; line-height: 1.6;
  -webkit-tap-highlight-color: transparent;
}
::-webkit-scrollbar { width:6px; height:6px; }
::-webkit-scrollbar-track { background:var(--bg-primary); }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

/* ========== LOGIN SCREEN ========== */
#loginScreen {
  display:flex; justify-content:center; align-items:center; min-height:100vh;
  background: radial-gradient(ellipse at 30% 20%, rgba(78,140,255,0.08) 0%, transparent 50%),
              radial-gradient(ellipse at 70% 80%, rgba(99,102,241,0.06) 0%, transparent 50%),
              var(--bg-primary);
  padding: 20px;
}
.login-card {
  background: var(--bg-card); border:1px solid var(--border); border-radius:var(--radius);
  padding: 48px 44px; width: 100%; max-width: 420px;
  box-shadow: 0 24px 80px rgba(0,0,0,0.5);
  animation: modalIn 0.5s cubic-bezier(0.16,1,0.3,1) both;
}
.login-card .login-icon { text-align:center; font-size:3.5rem; margin-bottom:16px; }
.login-card h1 { text-align:center; font-size:1.5rem; font-weight:800; margin-bottom:6px; }
.login-card .login-sub { text-align:center; font-size:0.9rem; color:var(--text-muted); margin-bottom:32px; }
.login-field { margin-bottom:20px; }
.login-field label { display:block; font-size:0.82rem; font-weight:700; color:var(--text-secondary); margin-bottom:8px; text-transform:uppercase; letter-spacing:0.5px; }
.login-field input {
  width:100%; padding:14px 18px; border-radius:var(--radius-sm);
  background:var(--bg-primary); border:1px solid var(--border);
  color:var(--text-primary); font-family:inherit; font-size:1rem; font-weight:500;
  outline:none; transition:all 0.2s;
}
.login-field input:focus { border-color:var(--accent-blue); box-shadow:0 0 0 3px rgba(78,140,255,0.15); }
.login-field input::placeholder { color:var(--text-muted); }
.login-error { color:var(--accent-rose); font-size:0.88rem; font-weight:600; text-align:center; margin-bottom:16px; min-height:1.4em; }
.btn-login {
  width:100%; padding:16px; border-radius:var(--radius-sm); border:none;
  background:linear-gradient(135deg,#4e8cff 0%,#6366f1 100%);
  color:#fff; font-family:inherit; font-size:1.1rem; font-weight:700;
  cursor:pointer; transition:all 0.25s;
  box-shadow:0 4px 20px rgba(78,140,255,0.3);
}
.btn-login:hover { transform:translateY(-1px); box-shadow:0 6px 28px rgba(78,140,255,0.45); }
.btn-login:active { transform:translateY(0); }
.login-footer { text-align:center; margin-top:24px; font-size:0.78rem; color:var(--text-muted); }

/* ========== DASHBOARD (hidden until login) ========== */
#dashboardScreen { display:none; }

/* Header */
.header {
  background: linear-gradient(180deg, #181b24 0%, var(--bg-primary) 100%);
  border-bottom: 1px solid var(--border);
  padding: 24px var(--pad-x) 20px; position: sticky; top:0; z-index:100;
}
.header-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px; gap:16px; }
.header-title-wrap { flex:1; min-width:0; }
.header h1 {
  font-size:1.75rem; font-weight:800; letter-spacing:-0.5px;
  background:linear-gradient(135deg,#fff 0%,#9ba1b0 100%);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
.header .subtitle { font-size:0.92rem; color:var(--text-secondary); margin-top:4px; font-weight:400; }
.header .subtitle span.sheet-lbl { color:var(--accent-cyan); font-weight:600; }
.header-actions { display:flex; gap:10px; align-items:center; flex-wrap:wrap; flex-shrink:0; }
.badge {
  padding:6px 14px; border-radius:50px; font-size:0.8rem; font-weight:600;
  border:1px solid var(--border); background:var(--bg-card); white-space:nowrap;
}
.badge.live { border-color:var(--accent-green); color:var(--accent-green); }
.badge.live::before { content:''; display:inline-block; width:7px; height:7px; border-radius:50%; background:var(--accent-green); margin-right:6px; animation:pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

.btn-logout {
  font-family:inherit; font-size:0.82rem; font-weight:600;
  padding:8px 16px; border-radius:var(--radius-sm);
  background:transparent; border:1px solid rgba(251,113,133,0.3);
  color:var(--accent-rose); cursor:pointer; transition:all 0.25s;
  display:inline-flex; align-items:center; gap:6px; white-space:nowrap;
}
.btn-logout:hover { border-color:var(--accent-rose); background:rgba(251,113,133,0.08); }

/* Filter Bar */
.filter-bar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.filter-bar input, .filter-bar select {
  font-family:inherit; font-size:0.95rem; font-weight:500;
  padding:10px 16px; border-radius:var(--radius-sm);
  background:var(--bg-card); border:1px solid var(--border);
  color:var(--text-primary); outline:none; transition:all 0.2s;
  min-width:0;
}
.filter-bar input { flex:1; min-width:180px; }
.filter-bar select { flex:0 1 200px; cursor:pointer; min-width:140px; }
.filter-bar input:focus, .filter-bar select:focus {
  border-color:var(--accent-blue); box-shadow:0 0 0 3px rgba(78,140,255,0.15);
}
.filter-bar input::placeholder { color:var(--text-muted); }

/* Buttons */
.btn-reset,.btn-import,.btn-clear {
  font-family:inherit; font-size:0.85rem; font-weight:600;
  padding:10px 18px; border-radius:var(--radius-sm);
  cursor:pointer; transition:all 0.25s; border:1px solid var(--border);
  display:inline-flex; align-items:center; gap:6px; white-space:nowrap;
}
.btn-reset { background:transparent; color:var(--text-secondary); }
.btn-reset:hover { border-color:var(--accent-rose); color:var(--accent-rose); }
.btn-import {
  background:linear-gradient(135deg,#4e8cff 0%,#6366f1 100%);
  color:#fff; border:none; box-shadow:0 2px 12px rgba(78,140,255,0.3);
}
.btn-import:hover { transform:translateY(-1px); box-shadow:0 4px 20px rgba(78,140,255,0.45); }
.btn-import:active { transform:translateY(0); }
.btn-import:disabled { opacity:0.5; cursor:not-allowed; transform:none; }
.btn-clear { background:transparent; color:var(--accent-amber); border-color:rgba(251,191,36,0.3); }
.btn-clear:hover { border-color:var(--accent-amber); background:rgba(251,191,36,0.08); }
.filter-spacer { flex:1; min-width:0; }
#fileInput { display:none; }

/* Toast */
.toast-container { position:fixed; top:24px; right:24px; z-index:9999; display:flex; flex-direction:column; gap:10px; }
.toast {
  padding:16px 44px 16px 20px; border-radius:var(--radius-sm);
  font-family:inherit; font-size:0.92rem; font-weight:600;
  display:flex; align-items:flex-start; gap:12px;
  min-width:320px; max-width:480px;
  box-shadow:0 8px 32px rgba(0,0,0,0.5);
  animation:toastIn 0.4s cubic-bezier(0.16,1,0.3,1) both;
  border:1px solid transparent; position:relative;
}
.toast.hiding { animation:toastOut 0.35s ease-in both; }
@keyframes toastIn { from{opacity:0;transform:translateX(60px) scale(0.95)} to{opacity:1;transform:translateX(0) scale(1)} }
@keyframes toastOut { to{opacity:0;transform:translateX(60px) scale(0.95)} }
.toast-icon { font-size:1.3rem; flex-shrink:0; line-height:1; margin-top:1px; }
.toast-body { flex:1; }
.toast-title { font-size:0.92rem; font-weight:700; margin-bottom:2px; }
.toast-msg { font-size:0.82rem; font-weight:400; opacity:0.85; line-height:1.5; }
.toast-close {
  position:absolute; top:10px; right:12px; background:none; border:none;
  color:inherit; opacity:0.5; cursor:pointer; font-size:1rem; line-height:1;
}
.toast-close:hover { opacity:1; }
.toast.success { background:#0d2818; border-color:rgba(52,211,153,0.3); color:var(--accent-green); }
.toast.error   { background:#2a0f14; border-color:rgba(251,113,133,0.3); color:var(--accent-rose); }
.toast.warning { background:#2a1f0a; border-color:rgba(251,191,36,0.3); color:var(--accent-amber); }
.toast.info    { background:#0f1a2e; border-color:rgba(78,140,255,0.3); color:var(--accent-blue); }

/* Import Modal */
.import-overlay {
  display:none; position:fixed; inset:0; z-index:500;
  background:rgba(0,0,0,0.6); backdrop-filter:blur(4px);
  justify-content:center; align-items:center; padding:20px;
}
.import-overlay.active { display:flex; }
.import-box {
  background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius);
  padding:36px 40px; max-width:520px; width:100%;
  box-shadow:0 24px 80px rgba(0,0,0,0.6); text-align:center;
  animation:modalIn 0.35s cubic-bezier(0.16,1,0.3,1) both;
}
@keyframes modalIn { from{opacity:0;transform:scale(0.92) translateY(20px)} to{opacity:1;transform:scale(1) translateY(0)} }
.import-box h2 { font-size:1.35rem; font-weight:800; margin-bottom:8px; }
.import-box p { color:var(--text-secondary); font-size:0.9rem; margin-bottom:24px; line-height:1.7; }
.drop-zone {
  border:2px dashed var(--border); border-radius:var(--radius-sm);
  padding:40px 24px; margin-bottom:20px; cursor:pointer; transition:all 0.25s;
  background:var(--bg-primary);
}
.drop-zone:hover,.drop-zone.dragover { border-color:var(--accent-blue); background:rgba(78,140,255,0.04); }
.drop-zone .dz-icon { font-size:2.5rem; margin-bottom:10px; }
.drop-zone .dz-text { font-size:0.95rem; color:var(--text-secondary); font-weight:600; }
.drop-zone .dz-hint { font-size:0.78rem; color:var(--text-muted); margin-top:6px; }
.drop-zone .dz-file { font-size:0.9rem; color:var(--accent-green); font-weight:700; margin-top:8px; display:none; }
.import-actions { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
.import-actions .btn-import { padding:12px 32px; font-size:1rem; }
.import-actions .btn-cancel {
  font-family:inherit; font-size:1rem; font-weight:600;
  padding:12px 32px; border-radius:var(--radius-sm);
  background:transparent; border:1px solid var(--border);
  color:var(--text-secondary); cursor:pointer; transition:all 0.2s;
}
.import-actions .btn-cancel:hover { border-color:var(--text-secondary); color:var(--text-primary); }
.spinner { display:none; margin:16px auto; }
.spinner.active { display:block; }
.spinner svg { animation:spin 1s linear infinite; width:36px; height:36px; }
@keyframes spin { to{transform:rotate(360deg)} }

/* Main */
.main { padding:24px var(--pad-x) 64px; }

/* Empty State */
.empty-state { text-align:center; padding:80px 20px; }
.empty-state .es-icon { font-size:3.5rem; margin-bottom:16px; opacity:0.6; }
.empty-state h2 { font-size:1.4rem; font-weight:700; color:var(--text-secondary); margin-bottom:8px; }
.empty-state p { color:var(--text-muted); font-size:0.95rem; max-width:400px; margin:0 auto 24px; line-height:1.7; }
.empty-state .btn-import { padding:14px 36px; font-size:1rem; }

/* Summary */
.summary-row { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:28px; }
.summary-card {
  background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius);
  padding:20px 22px; position:relative; overflow:hidden; transition:all 0.3s;
}
.summary-card:hover { border-color:var(--accent-blue); transform:translateY(-2px); box-shadow:var(--shadow-card); }
.summary-card .label { font-size:0.82rem; color:var(--text-secondary); font-weight:500; margin-bottom:6px; padding-right:50px; }
.summary-card .value { font-size:2rem; font-weight:800; }
.summary-card .sub { font-size:0.8rem; color:var(--text-muted); margin-top:4px; }
.summary-card .icon {
  position:absolute; top:18px; right:18px; width:42px; height:42px;
  border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:1.2rem;
}
.icon-blue { background:rgba(78,140,255,0.12); }
.icon-green { background:rgba(52,211,153,0.12); }
.icon-amber { background:rgba(251,191,36,0.12); }
.icon-rose  { background:rgba(251,113,133,0.12); }

/* Charts */
.charts-row { display:grid; grid-template-columns:2fr 1fr; gap:16px; margin-bottom:28px; }
.chart-card {
  background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius);
  padding:22px; transition:all 0.3s; overflow:hidden;
}
.chart-card:hover { box-shadow:var(--shadow-card); }
.chart-card h3 { font-size:1.05rem; font-weight:700; margin-bottom:16px; }

/* Legend */
.legend-bar {
  display:flex; gap:20px; align-items:center; margin-bottom:20px; flex-wrap:wrap;
  padding:12px 18px; background:var(--bg-card); border-radius:var(--radius-sm); border:1px solid var(--border);
}
.legend-item { display:flex; align-items:center; gap:6px; font-size:0.82rem; font-weight:600; color:var(--text-secondary); }
.legend-dot { width:10px; height:10px; border-radius:3px; }
.legend-dot.l67   { background:var(--accent-amber); }
.legend-dot.lself { background:var(--accent-cyan); }
.legend-dot.lmgr  { background:var(--accent-purple); }

/* Position Groups */
.position-group { margin-bottom:28px; }
.position-header {
  display:flex; align-items:center; gap:12px; margin-bottom:14px;
  padding-bottom:10px; border-bottom:2px solid var(--border);
}
.position-dot { width:12px; height:12px; border-radius:50%; }
.position-header h2 { font-size:1.2rem; font-weight:700; }
.position-count {
  font-size:0.8rem; color:var(--text-muted); font-weight:500;
  background:var(--bg-card); padding:3px 12px; border-radius:50px; border:1px solid var(--border);
}

/* Person Card */
.person-card {
  background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius);
  padding:22px 24px; margin-bottom:14px; transition:all 0.3s;
  animation:fadeInUp 0.4s ease-out both;
}
.person-card:hover { border-color:var(--accent-blue); box-shadow:var(--shadow-card); transform:translateY(-1px); }
@keyframes fadeInUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
.person-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:18px; gap:16px; }
.person-info { min-width:0; flex:1; }
.person-info h3 { font-size:1.1rem; font-weight:700; margin-bottom:4px; word-break:break-word; }
.person-info .pos-tag {
  display:inline-block; font-size:0.78rem; font-weight:600;
  padding:3px 12px; border-radius:50px;
}
.person-scores { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.score-pill {
  text-align:center; padding:8px 14px; border-radius:var(--radius-sm);
  background:var(--bg-primary); border:1px solid var(--border); min-width:90px;
}
.score-pill .sc-label { font-size:0.65rem; color:var(--text-muted); font-weight:600; text-transform:uppercase; letter-spacing:0.4px; margin-bottom:3px; }
.score-pill .sc-val { font-size:1.3rem; font-weight:800; }
.score-pill.highlight { border-color:var(--accent-blue); background:rgba(78,140,255,0.06); }

.comparison-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px 24px; }
.comp-item { display:flex; align-items:center; gap:10px; }
.comp-label { font-size:0.78rem; color:var(--text-secondary); min-width:140px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.comp-bars { flex:1; display:flex; flex-direction:column; gap:2px; }
.comp-bar-row { display:flex; align-items:center; gap:6px; }
.comp-bar-tag { font-size:0.6rem; font-weight:700; min-width:20px; color:var(--text-muted); }
.comp-bar-track { flex:1; height:7px; background:var(--bg-primary); border-radius:4px; overflow:hidden; }
.comp-bar-fill { height:100%; border-radius:4px; transition:width 0.8s ease-out; }
.comp-bar-val { font-size:0.7rem; font-weight:700; min-width:28px; text-align:right; }
.bar-67   { background:var(--accent-amber); }
.bar-self { background:var(--accent-cyan); }
.bar-mgr  { background:var(--accent-purple); }

.analysis-box {
  margin-top:16px; padding:14px 18px; border-radius:var(--radius-sm);
  background:linear-gradient(135deg,rgba(78,140,255,0.04) 0%,rgba(99,102,241,0.04) 100%);
  border:1px solid rgba(78,140,255,0.1);
}
.analysis-box .analysis-title { font-size:0.78rem; font-weight:700; color:var(--accent-blue); margin-bottom:5px; text-transform:uppercase; letter-spacing:0.5px; }
.analysis-box p { font-size:0.88rem; color:var(--text-secondary); line-height:1.7; }

.trend-up { color:var(--accent-green); }
.trend-down { color:var(--accent-rose); }
.trend-same { color:var(--accent-amber); }

.no-results { text-align:center; padding:60px 20px; color:var(--text-muted); font-size:1rem; }
.no-results .emoji { font-size:2.5rem; margin-bottom:12px; }

/* ========== RESPONSIVE ========== */
@media (max-width:1200px) {
  .summary-row { grid-template-columns:repeat(2,1fr); }
  .charts-row { grid-template-columns:1fr; }
}

@media (max-width:768px) {
  :root { --pad-x: 16px; }
  
  .header h1 { font-size:1.25rem; }
  .header .subtitle { font-size:0.78rem; }
  .header-top { flex-direction:column; gap:12px; }
  .header-actions { width:100%; justify-content:space-between; }
  
  .filter-bar { gap:8px; }
  .filter-bar input { min-width:0; flex:1 1 100%; }
  .filter-bar select { flex:1 1 100%; }
  .filter-spacer { display:none; }
  .filter-bar .btn-reset, .filter-bar .btn-import, .filter-bar .btn-clear { flex:1; justify-content:center; min-width:0; padding:10px 10px; font-size:0.8rem; }
  
  .summary-row { grid-template-columns:1fr 1fr; gap:10px; }
  .summary-card { padding:14px 16px; }
  .summary-card .value { font-size:1.6rem; }
  .summary-card .label { font-size:0.75rem; padding-right:40px; }
  .summary-card .icon { width:34px; height:34px; font-size:1rem; top:12px; right:12px; }
  
  .chart-card { padding:16px; }
  .chart-card h3 { font-size:0.92rem; }
  .chart-scroll { overflow-x:auto; -webkit-overflow-scrolling:touch; }
  .chart-scroll canvas { min-width:600px; height:320px !important; }
  
  .person-top { flex-direction:column; }
  .person-scores { width:100%; display:grid; grid-template-columns:repeat(2,1fr); gap:8px; }
  .score-pill { min-width:0; padding:8px 10px; }
  .score-pill .sc-val { font-size:1.15rem; }
  
  .comparison-grid { grid-template-columns:1fr; gap:8px; }
  .comp-label { min-width:100px; font-size:0.72rem; }
  .comp-bar-val { min-width:24px; font-size:0.65rem; }
  
  .analysis-box p { font-size:0.82rem; }
  
  .toast { min-width:260px; max-width:92vw; padding:14px 38px 14px 16px; font-size:0.85rem; }
  .toast-title { font-size:0.85rem; }
  .toast-msg { font-size:0.78rem; }
  
  .import-box { padding:24px 20px; }
  .import-box h2 { font-size:1.15rem; }
  .drop-zone { padding:30px 16px; }
  .drop-zone .dz-icon { font-size:2rem; }
  .drop-zone .dz-text { font-size:0.88rem; }
  
  .position-header h2 { font-size:1.05rem; }
  .person-info h3 { font-size:1rem; }
  
  .legend-bar { gap:12px; padding:10px 14px; }
  .legend-item { font-size:0.75rem; }
}

@media (max-width:480px) {
  .summary-row { grid-template-columns:1fr; }
  .score-pill .sc-label { font-size:0.6rem; }
  .header-actions .badge { font-size:0.72rem; padding:5px 10px; }
  .login-card { padding:32px 24px; }
  .login-card h1 { font-size:1.3rem; }
}
</style>
</head>
<body>

<!-- TOAST -->
<div class="toast-container" id="toastContainer"></div>

<!-- ==================== LOGIN SCREEN ==================== -->
<div id="loginScreen">
  <div class="login-card">
    <div class="login-icon">üîê</div>
    <h1>Executive Dashboard</h1>
    <div class="login-sub">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</div>
    <div class="login-field">
      <label>Username</label>
      <input type="text" id="loginUser" placeholder="Enter username" autocomplete="off" autocapitalize="off">
    </div>
    <div class="login-field">
      <label>Password</label>
      <input type="password" id="loginPass" placeholder="Enter password">
    </div>
    <div class="login-error" id="loginError"></div>
    <button class="btn-login" onclick="attemptLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <div class="login-footer">üõ°Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° ‡∏û.‡∏£.‡∏ö.‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (PDPA)</div>
  </div>
</div>

<!-- ==================== DASHBOARD SCREEN ==================== -->
<div id="dashboardScreen">

  <!-- Import Modal -->
  <div class="import-overlay" id="importOverlay">
    <div class="import-box">
      <h2>üìÇ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h2>
      <p>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå <strong>.xlsx</strong> ‡∏ó‡∏µ‡πà‡∏°‡∏µ 3 Sheet<br>
      <span style="color:var(--accent-amber)">‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span></p>
      <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <div class="dz-icon">üìÑ</div>
        <div class="dz-text">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á</div>
        <div class="dz-hint">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå .xlsx ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
        <div class="dz-file" id="dzFileName"></div>
      </div>
      <div class="spinner" id="importSpinner">
        <svg viewBox="0 0 50 50"><circle cx="25" cy="25" r="20" fill="none" stroke="var(--accent-blue)" stroke-width="4" stroke-dasharray="80 40" stroke-linecap="round"/></svg>
      </div>
      <div class="import-actions">
        <button class="btn-import" id="btnConfirmImport" onclick="confirmImport()" disabled>üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <button class="btn-cancel" onclick="closeImportModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- Header -->
  <div class="header">
    <div class="header-top">
      <div class="header-title-wrap">
        <h1>üìä Executive Performance Dashboard</h1>
        <div class="subtitle">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö 3 ‡∏£‡∏≠‡∏ö (<span class="sheet-lbl" id="sheetNames">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô 67 / ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ï‡∏ô‡πÄ‡∏≠‡∏á 68 / ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô 68</span>)</div>
      </div>
      <div class="header-actions">
        <span class="badge live">Dashboard</span>
        <span class="badge" id="badgeCount">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 11 ‡∏Ñ‡∏ô</span>
        <button class="btn-logout" onclick="doLogout()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>
    <div class="filter-bar">
      <input type="text" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." oninput="applyFilters()">
      <select id="positionFilter" onchange="applyFilters()">
        <option value="">‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>
      </select>
      <button class="btn-reset" onclick="resetFilters()">‚úï ‡∏•‡πâ‡∏≤‡∏á</button>
      <div class="filter-spacer"></div>
      <button class="btn-import" onclick="openImportModal()">üì• Import</button>
      <button class="btn-clear" onclick="clearDataConfirm()">üóëÔ∏è Clear</button>
      <input type="file" id="fileInput" accept=".xlsx" onchange="handleFileSelect(event)">
    </div>
  </div>

  <!-- Main Content -->
  <div class="main" id="mainContent">
    <div class="summary-row" id="summaryRow"></div>
    <div class="charts-row" id="chartsRow">
      <div class="chart-card">
        <h3>üìà ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö Totals 3 ‡∏£‡∏≠‡∏ö ‚Äî ‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h3>
        <div class="chart-scroll" style="position:relative;height:300px"><canvas id="barChart"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>üè∑Ô∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</h3>
        <div><canvas id="doughnutChart" height="220"></canvas></div>
      </div>
    </div>
    <div class="legend-bar" id="legendBar">
      <span style="font-weight:700;color:var(--text-primary);margin-right:6px;">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå:</span>
      <div class="legend-item"><div class="legend-dot l67"></div> <span id="lbl1">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô 67</span></div>
      <div class="legend-item"><div class="legend-dot lself"></div> <span id="lbl2">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ï‡∏ô‡πÄ‡∏≠‡∏á 68</span></div>
      <div class="legend-item"><div class="legend-dot lmgr"></div> <span id="lbl3">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô 68</span></div>
    </div>
    <div id="personContainer"></div>
  </div>
</div>

<script>
// ========== AUTH (SHA-256 hashed ‚Äî no plaintext credentials in source) ==========
const _h1 = 'ba8a96d5e6bd977e469fff203a17ac8b53682776119dd11081a6cede330cba6b';
const _h2 = '39eecc93dd906bc79fcf108be4c35122af40c6e7fdc17edefdec71b188d4e063';

async function sha256(text) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

async function attemptLogin() {
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value;
  const errEl = document.getElementById('loginError');
  const btn = document.querySelector('.btn-login');
  if (!u || !p) { errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Username ‡πÅ‡∏•‡∏∞ Password'; return; }
  btn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...'; btn.disabled = true;
  try {
    const uh = await sha256(u);
    const ph = await sha256(p);
    if (uh === _h1 && ph === _h2) {
      errEl.textContent = '';
      // Decrypt data using password ‚Äî only possible with correct credentials
      defaultData = await decryptPayload(p);
      showDashboard();
    } else {
      errEl.textContent = '‚ùå Username ‡∏´‡∏£‡∏∑‡∏≠ Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
      document.getElementById('loginPass').value = '';
    }
  } catch(e) {
    errEl.textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
  } finally {
    btn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'; btn.disabled = false;
  }
}

function showDashboard() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('dashboardScreen').style.display = 'block';
  initDashboard();
}

function doLogout() {
  // Wipe all data from memory (PDPA)
  rawData = []; defaultData = [];
  dashboardInitialized = false;
  document.getElementById('dashboardScreen').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
  document.getElementById('loginError').textContent = '';
}

// Enter key to login
document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') attemptLogin();
});

// ========== STATE ==========
let rawData = [];
let sheetLabels = ['‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô 67','‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ï‡∏ô‡πÄ‡∏≠‡∏á 68','‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô 68'];
let pendingFile = null;
let dashboardInitialized = false;

const criteria = ['‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô','‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÉ‡∏ô‡∏á‡∏≤‡∏ô','‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤','‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡∏£‡∏¥‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤','‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô','‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠-‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô','‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠-‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô','‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô','‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û'];
const colorPalette = ['#4e8cff','#a78bfa','#34d399','#fbbf24','#fb7185','#22d3ee','#f97316','#84cc16','#ec4899','#14b8a6'];
let posColors = {};

function assignColors() {
  const pos = [...new Set(rawData.map(d=>d.position))];
  posColors = {}; pos.forEach((p,i)=>posColors[p]=colorPalette[i%colorPalette.length]);
}

// ========== ENCRYPTED DATA (AES-256-GCM + PBKDF2) ==========
// No plaintext data in source ‚Äî decryption requires login password
const _encData = 'Cy+ylYN4Eje4dxRFa8kb1xId8gttj23ka7VZ9QbxghFW+0FAXaFFbL6n+1B7k1IJUqUd2W2miHPImy8qrwNN6gs8eWYVDI7x4f0vNn7uQSD4BA1kz9RL8HSUZbUn57pgzu4nNqY6OmhLdBbiqJ8IvH7syMbF7RtTfroVdS2wwQYDU1ziGX+ZlwiG+92N92vrc6/Kz5FV3YIpHeBkFtPOmrX6Kgmywlsm/h7Cli+IRwen0Ens1uCInNieY/FYTxdilJvJAfQv5o+BofD7zJVtZ9xutbwD3fjyidWi3CiSaLWuJ1EU2WuhhR5QFhHTlACHHHvb1K0u9Qeoq0hRF4wDJtHdE9+9EwsqVagdG2sOY2iHHnIkyt0ecKHhvTSOi2pQBcxcK+OG9k4xN/JnCzgt8RTYbjSVziwcXX3Qy3vMSN+R+a66uh20Kdu9aA8b7BUk/+mjTrN4fPbb0007yIP5/EHrspSskmMen46mpkaH/vKHAgCMykrtlP72tOLz03cLqpTJhc6YDvdsQ/XuJVfA5gvBlWVW2WFijOHJ6xuAhb5qkl4gpLdqjMFm1pmAFOUdYGqVhC+5VQ0pW0CO9WKetgh7QQ77VY0crGM6u9vFS49T+SxlmtnT3T/czoHHdP69U8t6XjnpsscjnHEcziSG/EcAvyV5CU7k9v4S3dmWHcrjGOyBguzWeXANT444/S8wsfmwf170Kwcx+PcwXzlbG93kv7g5BUzpydRU9bkQODun77jbfhSJ5Pz+kc+QHBcChM6An0U98n6gGPHVmLPn1wp1nnkvQwOkrRr4P3uncFXvyh1cWIRfyRgfKujGdQiIOUYUz1JO4HHsqmBybrC0iXnqY5UWzV7fc7rgwP/FjisYaKl+77qr4ZljpQA5QIZY6BDAl7p/Z2Xa7sJQCZGFajTIl1A4+hhLiWHrMCNFc5tBvG//+M5XwiFOzlv7bekeA7m4KYubVcEhLwc2feg8uXpBttzD5f7s52d89a4JjNfybmo0T69fU86nCC0FwODrOPhNmwKgCS7h1ahZB6GTtrPggvlFokXQlm5Mw4D4IYOBilWk0X+mZEfovbBKsDTYMT0m189WAZbP6G7AnlPnSboaA3ILZwgqxrH0CsBMt+YEwvJj4vDUlBkkKWAI93x2Hm3YanecOucWHTLe7P9rP0lZXUq3dRSFRmKmpCQ9hqCqfhxaWLvfuV6r45wzbR7z4Br6qYfZSm0mbcfs0vQ3Py9SltMRsk7uBtqjRHzQp+0YFDmU/p9P0VDf5BZpfYjqrqST54Ta16Q57yWUXRqeLiJNGNUgQjxC3CW0R8mZaNFGQQ72lHkjBRyQrd8skYb6Gpb9FCcjYaowqp7330TUCSSEgPCP84egkgXGIpntJhThDNOcewv//GGwFODLu6Cnp9rrU2Vt6lDjpE+QnXw6cfYZE90BSSLj+eYx2zlmCWnMD1dB+oCklpDbfVhz1WUdNWxb5Jj+v08vXx6uzU9KLfbW4/xyUFxgLdjXfjnwSAPMc2Q2xFh6M8ygaHsz//K4QvDVoQhRMJ+5ckT3Xw4LOe65X6oDI5PK+oVLbEnjCE02SXnvDXToIeSL3sTZkVMDy90F1cLRiVV2z51fH72Frsc1ETGlBnrQFDy/pfO7C+EDAzj0zFW1iB3XSEvzoqFi8vyp4qXnIuzKnwckEdl4a0zWMAn2ZaOMw54haqS24/8xxmd723T2zEgfdd7kE5kwHzAtaV1AxcDjUmOG1EZPq6IKycLFC5rGNMjx3aA1mP1Gh5GaxTObvb1xIlt+CWd08csE8IWAO3oggD7mDeombMuQfWI1YQ+OXnwToo+Dl5ulna8igBP8bpv/OWJrsOoc3Ik5MmJcBaq3oZioBx4ukgbWgiyucM4t1QugUfLa3+9tfK2n39hxqvCVZE7F360/l5fSqaWNyN9mYOxsrHau8NsR+7Nc9JMB2brbSU7Ry7l7zhdsgyvbcXjqMsAT+zEmATkoOOYqi2j/dA0nct5wW3bwPYoEvNj3IXtaVFpL2czi7eRibTrOOTvICvP+F8zDL2DEjvr6jesDPLLjnGa+2/QTM3r4MxX6x1RYa+4BMXdmYQF/CdQCE/pQ5QDZqPDwE+LVXluM/REtJoVv26GKXXeT+fOvcvnVQtC7qFCaoogSMF+U06EN6KXRaTD8zV9PbJ2+zh0JifpAW+0tmqeFTH21h711n7m1GkKnYoDnFnj5ZdA/DgqR/+GgYXAjY7HtjRpCxsmER7FuKSe/PA0O67lOwVrjm/37p3BZASJxSYLyiXVXjbGWhsj1FBrAB2w7ASl4xW9Qnb51+incQK73nIFsUnRqerA6g8I93NjYZ9QcJEC4pSNtW8lsnwUpi7DdDSmTrfVO1+c2apNOvpYt/A+QjlQuPHTYQ6ojVuTIO34G3mXhPrrTpYh5vQejuPtn2sg4TDgEq2aTmdR3b7Q4YP/ylgd1KVUass14N+A132BGzfWni4/+XmSvUqOJ87PZN6DBbS0QbDZxcL/zK/XYLmhadp7xeZ7nhLLh4uF6j0egGTSxMkgv+RJZApasjfMsRm68TwU7E69TE3QA4dBrT5+iug07Pw0Z5/eJZVNjW1Jp9AMjHoXXRJR5Iao6lq+Fn2EVqRzdk7jMqJ4SiBLjR4sbMlQe5QZCU/MTvfFKk/gaXLBUFnMermnXlwf+bNY7Z0qAlZEAqsUH1JP5tK6qNAIlz4SJPhwC15qYAcUbKv1ujEay2WukYFhv2nWWR/UPIWgzMams6OKsrUFnLRanGZDY3GB6mQ3aOQxkW96cMPuQapTTIjuIPZ7fhFcj/AXc9x+0iyvK78O5NHevCWax+CAiRTWnMP0LBCQuFHmIEXTzoCV6IPNvSuBgAoDPwj7IRC2SAhJTscQpyFZgk003C0KC5ZHjH7zXUqQU11BfUJkyBfz+4c43S6ojlKz8cKbO+egFftbF/eBxnRs/6X9RK/XkHl5C/U3WNc3nQ40zwUBt7H2rpDhSlL5GffjNjcCo23DiHxojKwK1y+hvTIqh8IiaRPpqsckw26dFNnBxW9A1RD9jLmEWtR7lbOfFtAKwDeMcRbKEksAc9ZUxvXgpf6JhMQEMmu26N4p9zk2xF/8c+kLu51k02jl8k/DwCynXeLaaXxGqBRQkQ68oF8S9v4xLfJKTt2752nfRnJo7eJzKVhlLSnvx3OeS8DpuVqw1Iny5y4F9Z2FBvqRsted+HmeTbyywFBlThrIvPcR7ba2ZirY3mcmG0BW6O1zwFqD9iCsgfmRY5JrXsTxi04ZAbz/U621n/TgEvqQhOB3ozu5cM77L7mCwWkv7cnwbLnVf3rzgD4HJdK/GpFx9R3bsVa1fsqwpzmWI4NrOsd8Axf+IaiZ0ESQ0MinCA5cVVyX8OGld5kS2klQLBw2XSes1/WoJaDmnTsHwIq2Lc9uqGi/E8YQ6u4U1ncrAbJpUGCIRqNivtZ9AMvSw5CBFWlxSeMAnnQjEpcr1R2LfZsjYmHWWohLXxGbRGgg5dOlugbz+/FH2LqgtSsZNqQCADB3J2goPE4+kbQR2JeuGCVOHMOTRYYZXje8+eM72uj38/7h49OONFku201Kx8273QdCVGWHKGh9Vio+MroURGL6u5C59M/GJ2hCY/F9lPQKKS1jFMkPqnfEHptPv/zH5qpq7NeUMZ3ZGvq/wRNGDtSwbJCGQ13dYcLyy1FAN3kee7/Kz8/zMlJiDpxVXQk09OH/I1o7xiTjAo8sOJu4M1nyqYdUMXVHnf7rX8bgCewy9mLC2qvuymfv3rY4cotmDAfNS8Vu79FRsB4OOhOmyvc4fZA6k5pF9/JEuz9iyljBF2YLrfPo+Euoz4YdPDdoFBp/TRIKkYn02dcy4DQu8dKB82aeFYCGcqPHk7iwwkIzapTNPjM818zPb0sc8fIRIi+EJXGd8YZO/EsBkrWbG9vbWH4SCPb14ZRtzpW6rVHcJr2r3mbWbnb67EM//Smlk+zeFVcl7FIID+8hkcrD5eh9zYEERpldnUYgM0+NQ/Mu9S5XNapgZe5jAON5hYPAlj0g4b43totE9CCqpssYG9399J8IlXIa/qCfpmrVRI3ZQD8NA14CEDzHjflwpzPtlzZh2S4eGKcNz5iNmMAR8BDRks8qSCrlgciSQRTRAIIm1wGhQF7O++3ZUD5n6o/nKUCRbReB2OBsj2sAwx24+cXdBn3hoGPjC9oZ0n89nC9M/lisoIPsmWWTjgeYYtFQGXTuq3d2bY9B1QL18w+u3sbLePAHSh/r5F74RboaPIRPEghhIrei5/XkKRNtARVN+Ti1GRHBEi8gMg7dGm6BaRWgSFAHT3OVN1z1jv18By5yqQcNUOU9BzFgv1oHdgIeQhV76A0lh+l4YPhGmcaM8CzaqVgiwU89p7xTFtKtJgtjTFkzD9RUbW174dWT+3K1eDBbcB6ML8QFk9CuSB3o73TG3ZUtRo/9tKmsLbHv7g1ct1kjt1NecH4UBB5bF6KTxEuUZ3U0u3xDuCD1hUAUSc4X8vrvFJd4z6Sq6zmFVhHgGH3hesW2FqmBP1cwJK8X/1Rzn0RkIcthl9LMngaO9gNxRdC4nMSBytqdCzr5t8WjDUUGMoz4AXxRov/3rl8RrNXbVZNKClYFK+V1CFDDFwAOFmCgQ8cs/2fp1xe+UTPIDMl1GO63RXHZGHd4WQ2Ue2E9ZcZ4hsehMhPsVmDBliFU5Fnpan2vmT9N6Mz3ehcSXDutCLmJb5iWHRDDmIrIktQioiieS1NRcmHExSpXZ5d8N+VNR6f5cNtC1UosKTsYcR/YFUHodYreSnsiDPvNvo48L2RWAqYwAvZMS/M/4kA1CM4qThMl1hSsN5PK7Tqvb8fsUeCsMSNkwwt7nz7ZwZ3kLX9hY9OakYWGdvHnE3qabcHzN6r99YmzMesbIclKAFQXmlK8WEh78B/4OSUq2vN/38JjWtBIXn4sMFE1+mgdOK72RVyKD5844xy+HU6vOHhFcQQVGJAVXm0UE4fCtRtoiHB9WbyFPm6OrBukRqeJdKK1lnJ3ew8Ls29bTMCD2a76dLptXtMwDKzL7H6A25ESu3uR7m7P+qFIfYBrym1UQOYYMF3/SNmcyGtQokLksRz2EqU6kzAa2mp/2Xi+eTD7ZTBTO0C2ZfJPILldiavEyltbKedHj2fZjDQUd/5qEoWhC6iHmndlpuP25lqzQWsR5AXrMBK7Gv7/4DdB7YKAmz0a+VFLZrioUe1Yy++eh032o76nj05yiJH5/34X4Ek5QCybu8lsaYfXYu1ucKlOL+Aw2WfxRQmodFzS3somFvtHd1WjJ2uALELrlvBCWOIX9o897fQ9NKokug2jIaF1JH2zDao/x+g5xRj6cv5xtHfI/OVtzcWhaRJzVRUVqsu2DaGprm2SQSZrkfTxpQJx/xL506YQcweXTZ5OCYSXS6kJpKx3k7vU98z+KkWUGe216DMKoNeG8PSI9goVORdSwfPoXCEAsgw8RtASJU/X8AnXA76K4piuflfYP3ig20Lru54Y0+bih2TH0dWjj9jfsEFBAEAfEorI+2Ci2jx5L0DmwKC6hW6j8IyXYc02DmpipBL+7qO/P0d2LAisg1dKEJIYJ4jflaAPq5of87a71U8//v6imr8Oe1F9NYYLf8joPxDPYpVd2M9Gq8+XJKgC8Uk+m0b5g2/WyGdHOTnVdv2gwy1xp02ukiqZSJ5Ujeb2Rt2yfu9UiOCJgbzZQWD3hL65Anklutp9gBEzOKODKKwwose2mY62cl4M3hrkiUaJODImbuAJWjYesocpvD1P6MJPbdR7PIfaexi8T1UHQzZBlnN5JVN6UVSyA36wYraH7jK+Ao9np83Sn4ZlR6Bqtze7jDgsReiyVVIB3TMt7puPr5KYvdYx/8eZBjmYAvO/Htm26qLxl8bB+7R99W70d14AuU5mwyarnoY57WHfQ+YtHaLyetc4otUCDAw3epDCcMxmae7Va7b56BlfzSdkBk+MXBeY+1YrCDwQ5qY9xlol3Ej1cEDZiudFX3ywH+7LODb21mWDpHdcAiRdDNxmedzeVvqpfi9GxcmvAWZKiSPn4TAFTnNWnyhZm2bWEckmd7ByyTTfJTr+c1rhYVtBzoOoI1JYVp8gQaL38fyYcvmbx1zEJBM+ZuE4tOl5dK3KEev0fSzIB1W2iTT3vuEAh+QE/jg2HOLe+6eHIlQoUifwiBcFnU0sOPozdFSRCHR8R1hDMjqAF4pR/rg5ikSuykSZjf4vwpBZtjv+O8D0PteFvTTpn+AduGtiUO6N/jnAQrHiRneVMRvTWPyuuPGVG8AW5p57Mp44n+CTehIHCFAc1Vsdc68FX9uqmdORGofAnPVm5ZpHPGL5D2vPxPifw2KC6eQY0QUl6DZ4obXyt8D1G1nUQ9Ux0nrS/jwB7vErOsDjTIg0yixMHm3NYpdPrd/pIsOAFAWsjSJW7Pm6NVWFHyAC5iDgqHiRSTxqmJm7gMQpTXmA/cJryLdzNxoS0jXRKqV5ZL2oyKs/y/FMS1UxN/8NsA6C/uTNFWPgeXb7F+RlOg4rF9d3hRC7LRfhtnPmYX9H/gBSIZErKNyyGJjbPGmI+1xAXWFuW3ZTL2RrdEBgnksO01ZBZrFftOTwKo31WHZr0G33Rn5H9Lu9GCtr10D4ed/pGcWn2n4mOqL5pmwcQ38dRL/DKZ8Jn+iknTdQzNkHP7+MXAYiyi1dwaSIRVbXc6suGZXpKpQozSPws6kMVSAbViPcD3GE5182uvpgEe5UYSqyV834JbKDVYE3/n9ATqr2PrSat2WENYRIFTS6s4poryfB86c+I9ayd+kHDmeE0SEnvRoYT';
let defaultData = [];

// Decrypt AES-256-GCM data using password via PBKDF2
async function decryptPayload(password) {
  const raw = Uint8Array.from(atob(_encData), c => c.charCodeAt(0));
  const salt = raw.slice(0, 16);
  const nonce = raw.slice(16, 28);
  const ciphertext = raw.slice(28);
  const keyMaterial = await crypto.subtle.importKey('raw', new TextEncoder().encode(password), 'PBKDF2', false, ['deriveKey']);
  const aesKey = await crypto.subtle.deriveKey({name:'PBKDF2', salt, iterations:100000, hash:'SHA-256'}, keyMaterial, {name:'AES-GCM', length:256}, false, ['decrypt']);
  const decrypted = await crypto.subtle.decrypt({name:'AES-GCM', iv:nonce}, aesKey, ciphertext);
  return JSON.parse(new TextDecoder().decode(decrypted));
}

// ========== TOAST ==========
function showToast(type,title,msg,dur=5000){
  const c=document.getElementById('toastContainer');
  const icons={success:'‚úÖ',error:'‚ùå',warning:'‚ö†Ô∏è',info:'‚ÑπÔ∏è'};
  const t=document.createElement('div'); t.className=`toast ${type}`;
  t.innerHTML=`<div class="toast-icon">${icons[type]||'‚ÑπÔ∏è'}</div><div class="toast-body"><div class="toast-title">${title}</div><div class="toast-msg">${msg}</div></div><button class="toast-close" onclick="this.parentElement.classList.add('hiding');setTimeout(()=>this.parentElement.remove(),350)">‚úï</button>`;
  c.appendChild(t); setTimeout(()=>{t.classList.add('hiding');setTimeout(()=>t.remove(),350);},dur);
}

// ========== IMPORT ==========
function openImportModal(){
  pendingFile=null; document.getElementById('fileInput').value='';
  document.getElementById('dzFileName').style.display='none';
  document.getElementById('btnConfirmImport').disabled=true;
  document.getElementById('importSpinner').classList.remove('active');
  document.getElementById('importOverlay').classList.add('active');
}
function closeImportModal(){ document.getElementById('importOverlay').classList.remove('active'); pendingFile=null; }

function initDropZone(){
  const dz=document.getElementById('dropZone');
  dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('dragover');});
  dz.addEventListener('dragleave',()=>dz.classList.remove('dragover'));
  dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('dragover');if(e.dataTransfer.files.length>0)processSelectedFile(e.dataTransfer.files[0]);});
}

function handleFileSelect(e){if(e.target.files.length>0)processSelectedFile(e.target.files[0]);}

function processSelectedFile(file){
  if(!file.name.toLowerCase().endsWith('.xlsx')){
    showToast('error','‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',`"${file.name}" ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà .xlsx<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Excel (.xlsx) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô`,6000);
    pendingFile=null; document.getElementById('dzFileName').style.display='none';
    document.getElementById('btnConfirmImport').disabled=true; return;
  }
  pendingFile=file; const el=document.getElementById('dzFileName');
  el.textContent=`üìé ${file.name} (${(file.size/1024).toFixed(1)} KB)`;
  el.style.display='block'; document.getElementById('btnConfirmImport').disabled=false;
  showToast('info','‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß',file.name);
}

function confirmImport(){
  if(!pendingFile)return;
  const spinner=document.getElementById('importSpinner'),btn=document.getElementById('btnConfirmImport');
  spinner.classList.add('active'); btn.disabled=true; btn.textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
      if(wb.SheetNames.length<3)throw new Error(`‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${wb.SheetNames.length} Sheet ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3`);
      const s1=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:null});
      const s2=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[1]],{defval:null});
      const s3=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[2]],{defval:null});
      sheetLabels=[wb.SheetNames[0],wb.SheetNames[1],wb.SheetNames[2]];
      const allNames=[...new Set([...s1.map(r=>r['Name']),...s2.map(r=>r['Name']),...s3.map(r=>r['Name'])])].filter(Boolean);
      rawData=allNames.map((nm,i)=>{
        const r1=s1.find(r=>r['Name']===nm)||{};const r2=s2.find(r=>r['Name']===nm)||{};const r3=s3.find(r=>r['Name']===nm)||{};
        const base=r2['Name']?r2:(r1['Name']?r1:r3);
        return{no:i+1,name:nm,position:base['Position']||r1['Position']||r3['Position']||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',eval67:parseRow(r1),self68:parseRow(r2),mgr68:parseRow(r3)};
      });
      const importedName=pendingFile.name;
      assignColors();updateUI();rebuildFilter();applyFilters();closeImportModal();
      showToast('success','‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',`${rawData.length} ‡∏Ñ‡∏ô ‡∏à‡∏≤‡∏Å ${importedName}`,6000);
    }catch(err){showToast('error','‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',err.message,7000);}
    finally{spinner.classList.remove('active');btn.disabled=false;btn.textContent='üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';}
  };
  reader.readAsArrayBuffer(pendingFile);
}

function parseRow(row){
  if(!row||!row['Name'])return{scores:[null,null,null,null,null,null,null,null,null,null],scoreWork:0,scorePerson:0,total:0};
  const skip=new Set(['No','Name','Position','Score ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô','Score ‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•','Totals','‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô']);
  const keys=Object.keys(row).filter(k=>!skip.has(k.trim()));
  const scores=keys.slice(0,10).map(k=>{const v=row[k];return v!=null&&v!==''?parseFloat(v)||null:null;});
  while(scores.length<10)scores.push(null);
  return{scores,scoreWork:parseFloat(row['Score ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô'])||0,scorePerson:parseFloat(row['Score ‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•'])||0,total:parseFloat(row['Totals'])||0};
}

// ========== CLEAR DATA ==========
function clearDataConfirm(){
  if(!rawData.length){showToast('warning','‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Import ‡∏Å‡πà‡∏≠‡∏ô');return;}
  if(confirm('‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?\n\n‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Import ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á')){
    rawData=[];assignColors();updateUI();rebuildFilter();renderEmpty();
    showToast('success','‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß','‡∏û‡∏£‡πâ‡∏≠‡∏° Import ‡πÉ‡∏´‡∏°‡πà');
  }
}
function renderEmpty(){
  document.getElementById('summaryRow').innerHTML='';
  document.getElementById('chartsRow').style.display='none';
  document.getElementById('legendBar').style.display='none';
  document.getElementById('personContainer').innerHTML=`
    <div class="empty-state"><div class="es-icon">üìÇ</div><h2>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx)</p>
    <button class="btn-import" onclick="openImportModal()">üì• Import Data</button></div>`;
}

// ========== UI ==========
function updateUI(){
  document.getElementById('badgeCount').textContent=rawData.length?`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${rawData.length} ‡∏Ñ‡∏ô`:'‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
  document.getElementById('sheetNames').textContent=sheetLabels.join(' / ');
  document.getElementById('lbl1').textContent=sheetLabels[0];
  document.getElementById('lbl2').textContent=sheetLabels[1];
  document.getElementById('lbl3').textContent=sheetLabels[2];
}
function rebuildFilter(){
  const sel=document.getElementById('positionFilter');
  sel.innerHTML='<option value="">‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>';
  [...new Set(rawData.map(d=>d.position))].forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p;sel.appendChild(o);});
}

// ========== UTILITIES ==========
function fmt(v){return v!=null&&v!==0?v.toFixed(2):'‚Äî';}
function fmtS(v){return v!=null&&v!==0?v.toFixed(1):'‚Äî';}
function getTrend(o,c){
  if(!o||o===0)return{icon:'üÜï',cls:'trend-same',text:'‡πÉ‡∏´‡∏°‡πà'};
  const d=c-o;
  if(d>0.05)return{icon:'‚ñ≤',cls:'trend-up',text:`+${d.toFixed(2)}`};
  if(d<-0.05)return{icon:'‚ñº',cls:'trend-down',text:`${d.toFixed(2)}`};
  return{icon:'‚Äî',cls:'trend-same',text:'‡∏Ñ‡∏á‡∏ó‡∏µ‡πà'};
}
function getGrade(t){
  if(t>=4.5)return{grade:'‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°',color:'#34d399'};
  if(t>=4.0)return{grade:'‡∏î‡∏µ‡∏°‡∏≤‡∏Å',color:'#4e8cff'};
  if(t>=3.5)return{grade:'‡∏î‡∏µ',color:'#a78bfa'};
  if(t>=3.0)return{grade:'‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á',color:'#fbbf24'};
  if(t>0)return{grade:'‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á',color:'#fb7185'};
  return{grade:'‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',color:'#6b7185'};
}

// ========== ANALYSIS (Cross-Sheet Average) ==========
function analyze(p){
  const sTotal=p.self68.total,mTotal=p.mgr68.total,eTotal=p.eval67.total;
  const mSc=p.mgr68.scores,sSc=p.self68.scores,eSc=p.eval67.scores;
  let r=[];
  const g=getGrade(mTotal);
  r.push(`‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÇ‡∏î‡∏¢${sheetLabels[2]}: <strong style="color:${g.color}">${fmt(mTotal)} (${g.grade})</strong>`);
  if(sTotal>0&&mTotal>0){const gap=sTotal-mTotal;if(gap>0.3)r.push(`‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤ ${gap.toFixed(2)} ‚Äî ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á`);else if(gap<-0.3)r.push(`‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡∏ô‡πÄ‡∏≠‡∏á ${Math.abs(gap).toFixed(2)} ‚Äî ‡∏°‡∏µ‡∏®‡∏±‡∏Å‡∏¢‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏ô‡πÄ‡∏≠‡∏á`);else r.push(`‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô (‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô ${Math.abs(gap).toFixed(2)})`);}
  if(eTotal>0&&mTotal>0){const y=mTotal-eTotal;if(y>0.1)r.push(`üìà ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å ${sheetLabels[0]} (+${y.toFixed(2)})`);else if(y<-0.1)r.push(`üìâ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏î‡∏à‡∏≤‡∏Å ${sheetLabels[0]} (${y.toFixed(2)})`);else r.push(`‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö ${sheetLabels[0]}`);}else if(eTotal===0)r.push(`‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${sheetLabels[0]}`);

  const hasM=mSc.some(v=>v!=null),hasS=sSc.some(v=>v!=null),hasE=eSc.some(v=>v!=null);
  let selfMgrIdentical=false;
  if(hasM&&hasS){selfMgrIdentical=mSc.every((v,i)=>v===sSc[i]);
    if(selfMgrIdentical)r.push(`<span style="color:var(--accent-amber)">‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${sheetLabels[1]} ‡∏Å‡∏±‡∏ö ${sheetLabels[2]} <strong>‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</strong> ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>`);
  }

  if(hasM){
    const pc=[];
    for(let i=0;i<10;i++){const vals=[];if(mSc[i]!=null)vals.push(mSc[i]);if(sSc[i]!=null)vals.push(sSc[i]);if(eSc[i]!=null)vals.push(eSc[i]);if(!vals.length)continue;
      pc.push({i,name:criteria[i]||('‡∏´‡∏°‡∏ß‡∏î '+(i+1)),avg:vals.reduce((s,x)=>s+x,0)/vals.length,mgrVal:mSc[i],selfVal:sSc[i],e67Val:eSc[i],rounds:vals.length,highCount:vals.filter(x=>x>=4).length,lowCount:vals.filter(x=>x<=3).length});}
    if(pc.length>0){
      const sorted=[...pc].sort((a,b)=>b.avg-a.avg);const maxA=sorted[0].avg,minA=sorted[sorted.length-1].avg;
      if(maxA!==minA){
        const tops=sorted.filter(c=>c.avg>=maxA-0.3).map(c=>`${c.name} (${c.avg.toFixed(1)}${c.highCount===c.rounds?' ‚úì':''})`);
        const bots=sorted.filter(c=>c.avg<=minA+0.3).map(c=>`${c.name} (${c.avg.toFixed(1)}${c.lowCount===c.rounds?' ‚úó':''})`);
        r.push(`üí™ ‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î): ${tops.join(', ')}`);
        r.push(`üîß ‡∏Ñ‡∏ß‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤ (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î): ${bots.join(', ')}`);
      }else r.push(`‚ÑπÔ∏è ‡∏ó‡∏∏‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô (${maxA.toFixed(1)})`);

      if(!selfMgrIdentical&&hasS){
        const gaps=pc.filter(c=>c.mgrVal!=null&&c.selfVal!=null).map(c=>({...c,gap:c.selfVal-c.mgrVal})).filter(c=>Math.abs(c.gap)>=0.5).sort((a,b)=>Math.abs(b.gap)-Math.abs(a.gap));
        if(gaps.length>0){let gp=[];const ov=gaps.filter(g=>g.gap>0).slice(0,3);const un=gaps.filter(g=>g.gap<0).slice(0,3);
          if(ov.length)gp.push(`‚ö° ‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤: ${ov.map(g=>g.name+' (+'+g.gap.toFixed(1)+')').join(', ')}`);
          if(un.length)gp.push(`üéØ ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤: ${un.map(g=>g.name+' ('+g.gap.toFixed(1)+')').join(', ')}`);
          if(gp.length)r.push(gp.join('<br>'));
        }
      }
      if(hasE){
        const yoy=pc.filter(c=>c.mgrVal!=null&&c.e67Val!=null).map(c=>({...c,diff:c.mgrVal-c.e67Val})).filter(c=>Math.abs(c.diff)>=0.5).sort((a,b)=>Math.abs(b.diff)-Math.abs(a.diff));
        if(yoy.length>0){let yp=[];const imp=yoy.filter(y=>y.diff>0).slice(0,3);const dec=yoy.filter(y=>y.diff<0).slice(0,3);
          if(imp.length)yp.push(`üöÄ ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏õ‡∏µ‡∏Å‡πà‡∏≠‡∏ô: ${imp.map(y=>y.name+' (+'+y.diff.toFixed(1)+')').join(', ')}`);
          if(dec.length)yp.push(`‚ö†Ô∏è ‡∏•‡∏î‡∏•‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏µ‡∏Å‡πà‡∏≠‡∏ô: ${dec.map(y=>y.name+' ('+y.diff.toFixed(1)+')').join(', ')}`);
          if(yp.length)r.push(yp.join('<br>'));
        }
      }
    }
  }
  return r.join('<br>');
}

// ========== RENDER ==========
function renderSummary(data){
  const c=document.getElementById('summaryRow');if(!data.length){c.innerHTML='';return;}
  const pc=[...new Set(data.map(d=>d.position))].length;
  const wM=data.filter(d=>d.mgr68.total>0),wS=data.filter(d=>d.self68.total>0);
  const aM=wM.length?wM.reduce((s,d)=>s+d.mgr68.total,0)/wM.length:0;
  const aS=wS.length?wS.reduce((s,d)=>s+d.self68.total,0)/wS.length:0;
  const top=[...data].filter(d=>d.mgr68.total>0).sort((a,b)=>b.mgr68.total-a.mgr68.total)[0];
  c.innerHTML=`
    <div class="summary-card"><div class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</div><div class="value">${data.length}</div><div class="sub">${pc} ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div><div class="icon icon-blue">üë•</div></div>
    <div class="summary-card"><div class="label">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (${sheetLabels[2]})</div><div class="value" style="color:var(--accent-green)">${aM.toFixed(2)}</div><div class="sub">${getGrade(aM).grade}</div><div class="icon icon-green">üìä</div></div>
    <div class="summary-card"><div class="label">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (${sheetLabels[1]})</div><div class="value" style="color:var(--accent-cyan)">${aS.toFixed(2)}</div><div class="sub">Gap: ${(aS-aM).toFixed(2)}</div><div class="icon icon-amber">üìù</div></div>
    <div class="summary-card"><div class="label">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (${sheetLabels[2]})</div><div class="value" style="color:var(--accent-purple)">${top?fmt(top.mgr68.total):'‚Äî'}</div><div class="sub">${top?top.name.match(/\(([^)]+)\)/)?.[1]||top.name:'‚Äî'}</div><div class="icon icon-rose">üèÜ</div></div>`;
}

let barC=null,doughC=null;
function renderCharts(data){
  document.getElementById('chartsRow').style.display=data.length?'grid':'none';
  document.getElementById('legendBar').style.display=data.length?'flex':'none';
  if(!data.length)return;
  const sorted=[...data].sort((a,b)=>b.mgr68.total-a.mgr68.total);
  const labels=sorted.map(d=>{const m=d.name.match(/\(([^)]+)\)/);return m?m[1]:d.name.substring(0,10);});
  const ctx1=document.getElementById('barChart').getContext('2d');
  if(barC)barC.destroy(); Chart.register(ChartDataLabels);
  barC=new Chart(ctx1,{type:'bar',data:{labels,datasets:[
    {label:sheetLabels[0],data:sorted.map(d=>d.eval67.total||null),backgroundColor:'rgba(251,191,36,0.7)',borderColor:'#fbbf24',borderWidth:1,borderRadius:4},
    {label:sheetLabels[1],data:sorted.map(d=>d.self68.total||null),backgroundColor:'rgba(34,211,238,0.7)',borderColor:'#22d3ee',borderWidth:1,borderRadius:4},
    {label:sheetLabels[2],data:sorted.map(d=>d.mgr68.total||null),backgroundColor:'rgba(167,139,250,0.7)',borderColor:'#a78bfa',borderWidth:1,borderRadius:4}
  ]},options:{responsive:true,maintainAspectRatio:false,layout:{padding:{top:30}},plugins:{legend:{labels:{color:'#9ba1b0',font:{family:'Noto Sans Thai',size:11,weight:'600'},padding:16}},datalabels:{anchor:'end',align:'end',offset:2,rotation:-90,color:ctx=>['#fbbf24','#22d3ee','#a78bfa'][ctx.datasetIndex]||'#9ba1b0',font:{family:'Noto Sans Thai',size:10,weight:'700'},formatter:v=>(v===null||v===0)?'':v.toFixed(2),padding:{bottom:2}}},scales:{x:{ticks:{color:'#9ba1b0',font:{family:'Noto Sans Thai',size:11,weight:'600'},maxRotation:45},grid:{color:'rgba(42,46,59,0.5)'}},y:{min:0,max:5.5,ticks:{color:'#9ba1b0',stepSize:1,font:{size:11}},grid:{color:'rgba(42,46,59,0.5)'}}}}});

  const pcnt={};data.forEach(d=>{pcnt[d.position]=(pcnt[d.position]||0)+1;});
  const ctx2=document.getElementById('doughnutChart').getContext('2d');
  if(doughC)doughC.destroy();
  doughC=new Chart(ctx2,{type:'doughnut',data:{labels:Object.keys(pcnt),datasets:[{data:Object.values(pcnt),backgroundColor:Object.keys(pcnt).map(p=>posColors[p]||'#6b7185'),borderColor:'#181b24',borderWidth:3}]},options:{responsive:true,cutout:'60%',plugins:{datalabels:{display:false},legend:{position:'bottom',labels:{color:'#9ba1b0',font:{family:'Noto Sans Thai',size:11,weight:'600'},padding:12}}}}});
}

function renderCards(data){
  const c=document.getElementById('personContainer');
  if(!data.length&&!rawData.length){renderEmpty();return;}
  if(!data.length){c.innerHTML='<div class="no-results"><div class="emoji">üîç</div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';return;}
  const groups={};data.forEach(d=>{if(!groups[d.position])groups[d.position]=[];groups[d.position].push(d);});
  Object.values(groups).forEach(g=>g.sort((a,b)=>b.mgr68.total-a.mgr68.total));
  const sPos=Object.keys(groups).sort((a,b)=>{
    return groups[b].reduce((s,d)=>s+d.mgr68.total,0)/groups[b].length - groups[a].reduce((s,d)=>s+d.mgr68.total,0)/groups[a].length;
  });
  let h='';
  sPos.forEach((pos,pi)=>{
    const ppl=groups[pos],col=posColors[pos]||'#6b7185';
    h+=`<div class="position-group"><div class="position-header"><div class="position-dot" style="background:${col}"></div><h2>${pos}</h2><span class="position-count">${ppl.length} ‡∏Ñ‡∏ô</span></div>`;
    ppl.forEach((p,idx)=>{
      const tr=getTrend(p.eval67.total,p.mgr68.total);
      h+=`<div class="person-card" style="animation-delay:${(pi*3+idx)*0.06}s">
        <div class="person-top"><div class="person-info"><h3>${p.name}</h3><span class="pos-tag" style="background:${col}15;color:${col};border:1px solid ${col}33">${p.position}</span></div>
        <div class="person-scores">
          <div class="score-pill"><div class="sc-label">${sheetLabels[0]}</div><div class="sc-val" style="color:var(--accent-amber)">${fmt(p.eval67.total)}</div></div>
          <div class="score-pill"><div class="sc-label">${sheetLabels[1]}</div><div class="sc-val" style="color:var(--accent-cyan)">${fmt(p.self68.total)}</div></div>
          <div class="score-pill highlight"><div class="sc-label">${sheetLabels[2]}</div><div class="sc-val" style="color:var(--accent-purple)">${fmt(p.mgr68.total)}</div></div>
          <div class="score-pill"><div class="sc-label">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°</div><div class="sc-val ${tr.cls}" style="font-size:1rem">${tr.icon} ${tr.text}</div></div>
        </div></div>
        <div class="comparison-grid">${criteria.map((cr,i)=>{
          const v1=p.eval67.scores[i],v2=p.self68.scores[i],v3=p.mgr68.scores[i];
          return `<div class="comp-item"><div class="comp-label">${cr}</div><div class="comp-bars">
            <div class="comp-bar-row"><span class="comp-bar-tag">67</span><div class="comp-bar-track"><div class="comp-bar-fill bar-67" style="width:${v1?v1/5*100:0}%"></div></div><span class="comp-bar-val" style="color:var(--accent-amber)">${v1!=null?fmtS(v1):'‚Äî'}</span></div>
            <div class="comp-bar-row"><span class="comp-bar-tag">‡∏ï‡∏ô</span><div class="comp-bar-track"><div class="comp-bar-fill bar-self" style="width:${v2?v2/5*100:0}%"></div></div><span class="comp-bar-val" style="color:var(--accent-cyan)">${v2!=null?fmtS(v2):'‚Äî'}</span></div>
            <div class="comp-bar-row"><span class="comp-bar-tag">‡∏´‡∏ô.</span><div class="comp-bar-track"><div class="comp-bar-fill bar-mgr" style="width:${v3?v3/5*100:0}%"></div></div><span class="comp-bar-val" style="color:var(--accent-purple)">${v3!=null?fmtS(v3):'‚Äî'}</span></div>
          </div></div>`;}).join('')}</div>
        <div class="analysis-box"><div class="analysis-title">üîé ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏£‡∏∏‡∏õ</div><p>${analyze(p)}</p></div>
      </div>`;
    });
    h+='</div>';
  });
  c.innerHTML=h;
}

// ========== FILTER ==========
function applyFilters(){
  const s=document.getElementById('searchInput').value.trim().toLowerCase();
  const p=document.getElementById('positionFilter').value;
  let f=rawData;
  if(s)f=f.filter(d=>d.name.toLowerCase().includes(s));
  if(p)f=f.filter(d=>d.position===p);
  renderSummary(f);renderCharts(f);renderCards(f);
}
function resetFilters(){
  document.getElementById('searchInput').value='';
  document.getElementById('positionFilter').value='';
  applyFilters();
}

// ========== INIT ==========
function initDashboard(){
  if(dashboardInitialized)return; dashboardInitialized=true;
  initDropZone();
  rawData=[...defaultData]; assignColors(); updateUI(); rebuildFilter(); applyFilters();
}
</script>
</body>
</html>
